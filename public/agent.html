<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJ STUDIOZ - Advanced Agentic AI Assistant</title>
    
    <!-- Professional Favicon -->
    <link rel="icon" href="https://z-cdn-media.chatglm.cn/files/2c638f76-2af9-4185-825a-c348837ca84f_favicon.png?auth_key=1790583710-975e3e49e295497baa7912be33ce27b7-0-57a08d78563be12ae5845c400026c2a0" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Poppins:wght@300;400;600&family=Play:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- Additional Libraries for Advanced Features -->
    <script src="https://cdn.jsdelivr.net/npm/compromise@14.11.0/builds/compromise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    
    <style>
        /* Existing styles remain the same with enhancements */
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f7f7f8;
            --sidebar-bg: #f7f7f8;
            --input-bg: #ffffff;
            --text-primary: #0f0f0f;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --accent-color: #ff6b35;
            --border-color: #e5e5e7;
            --hover-bg: #f0f0f0;
            --message-user-bg: #f0f2f5;
            --message-ai-bg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --logo-gradient: linear-gradient(135deg, var(--accent-color), #ff8c61);
            --aj-gold: #FBBF24;
            --aj-gold-glow: rgba(251, 191, 36, 0.6);
            --aj-green: #34D399;
            --aj-green-glow: rgba(52, 211, 153, 0.7);
            --code-bg: #000000;
            --code-text: #ffffff;
            --copilot-text: #1e1e1e;
            --copilot-bg: #f6f8fa;
            --copilot-border: #d1d9e0;
            --copilot-code-bg: #0d1117;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #ffffff;
            --modal-border-radius: 16px;
            --javascript-color: #f7df1e;
            --python-color: #3776ab;
            --html-color: #e34c26;
            --css-color: #1572b6;
            --typescript-color: #3178c6;
            --java-color: #007396;
            --cpp-color: #00599c;
            --json-color: #000000;
            --markdown-color: #083fa1;
            --sql-color: #336791;
            --shell-color: #89e051;
            --yaml-color: #cb171e;
            --xml-color: #0060ac;
            --code-header-bg: #1a1a1a;
            --code-header-border: #30363d;
            --code-action-bg: #21262d;
            --code-action-hover: #30363d;
            --corporate-blue: #1e40af;
            --corporate-gray: #f8fafc;
            --corporate-dark: #1e293b;
            --logo-url: url("https://z-cdn-media.chatglm.cn/files/2c638f76-2af9-4185-825a-c348837ca84f_favicon.png?auth_key=1790583710-975e3e49e295497baa7912be33ce27b7-0-57a08d78563be12ae5845c400026c2a0");
            --logo-glow: 0 0 10px rgba(0, 0, 0, 0.2);
            --agent-status-online: #10b981;
            --agent-status-busy: #f59e0b;
            --agent-status-offline: #ef4444;
            --proactive-bg: rgba(16, 185, 129, 0.1);
            --collaboration-bg: rgba(59, 130, 246, 0.1);
        }

        [data-theme="dark"] {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2d2d2d;
            --sidebar-bg: #0f0f0f;
            --input-bg: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #707070;
            --hover-bg: #404040;
            --message-user-bg: #2a4f3a;
            --message-ai-bg: #1e1e1e;
            --border-color: #404040;
            --code-bg: #000000;
            --code-text: #ffffff;
            --copilot-text: #e6edf3;
            --copilot-bg: #161b22;
            --copilot-border: #30363d;
            --copilot-code-bg: #0d1117;
            --modal-bg: rgba(0, 0, 0, 0.85);
            --modal-content-bg: #2d2d2d;
            --code-header-bg: #1a1a1a;
            --code-header-border: #30363d;
            --code-action-bg: #21262d;
            --code-action-hover: #30363d;
            --logo-glow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Login Page Styles */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #020202 0%, #1a1a1a 100%);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        .spotlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0) 40%);
            pointer-events: none;
            transition: transform 0.1s ease-out;
        }

        .vault-container {
            position: relative;
            width: 450px;
            height: 450px;
            perspective: 1500px;
        }

        #vault-toggle {
            display: none;
        }

        .vault-door {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transform-origin: left center;
            transition: transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transition-delay: 1.2s; 
            cursor: pointer;
            z-index: 20;
            animation: door-intro 1s ease-out forwards;
            opacity: 0;
        }
        
        #vault-toggle:checked ~ .vault-door {
            transform: rotateY(-130deg) translateX(-20px);
        }

        .door-face {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #444444, #2a2a2a);
            border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.7), 5px 5px 30px rgba(0,0,0,0.8);
            backface-visibility: hidden;
            overflow: hidden;
        }
        
        .door-face::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200%;
            background: linear-gradient(0deg, transparent 50%, rgba(0, 255, 140, 0.05) 50%);
            background-size: 100% 6px;
            animation: scanlines 10s linear infinite;
        }

        .door-face.front {
            transform: translateZ(40px);
            border: 5px solid #1a1a1a;
        }
        
        .door-face.back {
            background: #2a2a2a;
            transform: rotateY(180deg) translateZ(40px);
        }
        
        .locking-bar {
            position: absolute;
            background: linear-gradient(to right, #2c2c2c, #4a4a4a, #2c2c2c);
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            transition: transform 0.5s cubic-bezier(0.65, 0, 0.35, 1);
            z-index: -1;
        }
        .locking-bar.horizontal { left: -15%; width: 130%; height: 30px; }
        .locking-bar.vertical { top: -15%; width: 30px; height: 130%; background: linear-gradient(to bottom, #2c2c2c, #4a4a4a, #2c2c2c); }
        
        .locking-bar:nth-of-type(1) { top: 30%; animation: slide-in-right 1s 0.2s forwards; transform: translateX(150%); } 
        .locking-bar:nth-of-type(2) { bottom: 30%; animation: slide-in-left 1s 0.2s forwards; transform: translateX(-150%); } 
        .locking-bar:nth-of-type(3) { left: 30%; animation: slide-in-down 1s 0.4s forwards; transform: translateY(150%); } 
        .locking-bar:nth-of-type(4) { right: 30%; animation: slide-in-up 1s 0.4s forwards; transform: translateY(-150%); } 

        .vault-handle {
            position: absolute;
            top: 50%; left: 50%;
            width: 220px;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            transition: transform 0.8s ease-in-out;
            transform: translate(-50%, -50%) scale(0);
            animation: handle-intro 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.8s forwards;
        }
        
        .handle-ring {
            position: absolute;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, #2c2c2c, #4a4a4a);
            border-radius: 50%;
            border: 8px solid #222;
            box-shadow: 0 0 35px rgba(0,0,0,0.9), inset 0 0 15px #000;
        }
        
        .handle-center {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid #f0e68c;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
            animation: pulse-gold 2.5s infinite;
            z-index: 10;
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
            box-shadow: var(--logo-glow);
        }

        #vault-toggle:checked ~ .vault-door .handle-ring {
            animation: turn-handle 1s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards;
        }
        #vault-toggle:checked ~ .vault-door .handle-center {
            background: linear-gradient(145deg, #34D399, #16a34a);
            border-color: #a7f3d0;
            box-shadow: 0 0 35px rgba(52, 211, 153, 0.7), inset 0 0 10px rgba(0,0,0,0.5);
            animation: none;
        }
        #vault-toggle:checked ~ .vault-door .locking-bar:nth-of-type(1) { animation: retract-right 0.5s 0.7s forwards; }
        #vault-toggle:checked ~ .vault-door .locking-bar:nth-of-type(2) { animation: retract-left 0.5s 0.7s forwards; }
        #vault-toggle:checked ~ .vault-door .locking-bar:nth-of-type(3) { animation: retract-down 0.5s 0.7s forwards; }
        #vault-toggle:checked ~ .vault-door .locking-bar:nth-of-type(4) { animation: retract-up 0.5s 0.7s forwards; }

        .login-form-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: inset 0 0 50px #000;
            padding: 40px;
            box-sizing: border-box;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .login-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            text-align: center;
            font-weight: 700;
            text-transform: uppercase;
            margin: 0 0 10px;
            color: #E5E7EB;
            letter-spacing: 0.1em;
            text-shadow: 0 0 5px rgba(255,255,255,0.2), 0 0 15px rgba(52, 211, 153, 0.7);
            animation: glitch 5s infinite;
        }

        .login-form-container h2 { margin: 0 0 10px; color: #FBBF24; font-family: 'Play', sans-serif; font-size: 1.8rem; text-align: center; text-shadow: 0 0 10px rgba(251, 191, 36, 0.6); }
        .login-form-container p { margin: 0 0 30px; color: #E5E7EB; font-size: 0.9rem; text-align: center; opacity: 0.8; }
        .input-group { position: relative; width: 100%; margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid #2a2a2a; border-radius: 5px; color: #E5E7EB; font-size: 1rem; box-sizing: border-box; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
        .input-group input:focus { border-color: #FBBF24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.6); }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 5px; background: #FBBF24; color: #111; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .login-button:hover { background-color: #ffdf85; box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); transform: translateY(-3px); }
        .login-button:active { transform: translateY(-1px); }
        
        .google-login-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #4285F4;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-login-button:hover {
            background-color: #357ae8;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.6);
            transform: translateY(-3px);
        }
        
        .google-login-button:active {
            transform: translateY(-1px);
        }
        
        .signup-link {
            text-align: center;
            margin-top: 20px;
            color: #E5E7EB;
            font-size: 0.9rem;
        }
        
        .signup-link a {
            color: #FBBF24;
            text-decoration: none;
            font-weight: 600;
        }
        
        .signup-link a:hover {
            text-decoration: underline;
        }

        @keyframes door-intro { to { opacity: 1; } }
        @keyframes handle-intro { to { transform: translate(-50%, -50%) scale(1); } }
        @keyframes slide-in-left { to { transform: translateX(0); } }
        @keyframes slide-in-right { to { transform: translateX(0); } }
        @keyframes slide-in-up { to { transform: translateY(0); } }
        @keyframes slide-in-down { to { transform: translateY(0); } }
        
        @keyframes pulse-gold {
            0%, 100% { box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 0 15px rgba(251, 191, 36, 0.6); }
            50% { box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 0 25px rgba(251, 191, 36, 0.6); }
        }
        @keyframes turn-handle {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-15deg); }
            80% { transform: rotate(200deg); }
            100% { transform: rotate(180deg); }
        }
        @keyframes retract-up { to { transform: translateY(-150%); } }
        @keyframes retract-down { to { transform: translateY(150%); } }
        @keyframes retract-left { to { transform: translateX(-150%); } }
        @keyframes retract-right { to { transform: translateX(150%); } }
        
        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }
        
        @keyframes glitch { 
            0%, 100% { text-shadow: 0 0 5px rgba(255,255,255,0.2), 0 0 15px rgba(52, 211, 153, 0.7); } 
            49% { text-shadow: 0 0 5px rgba(255,255,255,0.2), 0 0 15px rgba(52, 211, 153, 0.7); } 
            50% { text-shadow: 2px 2px 5px rgba(52, 211, 153, 0.7), -2px -2px 5px rgba(251, 191, 36, 0.6); } 
            51% { text-shadow: 0 0 5px rgba(255,255,255,0.2), 0 0 15px rgba(52, 211, 153, 0.7); } 
        }

        /* Enhanced Main App Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--logo-glow);
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
            transition: transform 0.3s ease;
        }

        .logo-icon:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .new-chat-btn {
            width: 100%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .new-chat-btn:hover {
            background-color: #e55a30;
            transform: translateY(-1px);
        }

        .search-bar {
            margin: 16px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px 8px;
        }

        .chat-history-item {
            padding: 10px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-history-item:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .chat-history-item.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
        }

        .chat-history-item i {
            font-size: 12px;
            opacity: 0.6;
        }

        .project-section {
            margin-top: 16px;
            padding: 0 8px;
        }

        .project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            color: var(--text-tertiary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .project-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-item:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-profile:hover {
            background-color: var(--hover-bg);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-status {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Enhanced Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--primary-bg);
            position: relative;
        }

        .main-header {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background-color: var(--secondary-bg);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
            box-shadow: var(--logo-glow);
            transition: transform 0.3s ease;
        }

        .ai-avatar:hover {
            transform: scale(1.1);
        }

        .header-title h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-selector {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            outline: none;
            transition: all 0.2s ease;
        }

        .model-selector:hover {
            background-color: var(--hover-bg);
        }

        .tone-selector {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            outline: none;
            transition: all 0.2s ease;
        }

        .tone-selector:hover {
            background-color: var(--hover-bg);
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .header-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        /* Enhanced Agent Status Bar */
        .agent-status-bar {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            height: 30px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            font-size: 12px;
            z-index: 5;
        }

        .agent-status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--agent-status-online);
            box-shadow: 0 0 4px var(--agent-status-online);
        }

        .agent-status-indicator.busy {
            background-color: var(--agent-status-busy);
            box-shadow: 0 0 4px var(--agent-status-busy);
        }

        .agent-status-indicator.offline {
            background-color: var(--agent-status-offline);
            box-shadow: 0 0 4px var(--agent-status-offline);
        }

        /* Enhanced Quota Usage Bar */
        .quota-usage {
            position: absolute;
            top: 90px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--border-color);
            z-index: 10;
        }

        .quota-usage-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--aj-gold), #ff8c61);
            transition: width 0.3s ease;
        }

        /* Enhanced Plan Upgrade Banner */
        .upgrade-banner {
            background: linear-gradient(135deg, var(--aj-gold), #ff8c61);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .upgrade-banner button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .upgrade-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Chat Layout */
        .chat-layout {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 200px);
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Enhanced Right Sidebar */
        .sidebar-right {
            width: 350px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }

        .sidebar-right.active {
            display: flex;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .sidebar-tab.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        .sidebar-tab:hover {
            background-color: var(--hover-bg);
        }

        .tab-content {
            flex: 1;
            padding: 16px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .preview-container {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .preview-header {
            background-color: var(--hover-bg);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-actions {
            display: flex;
            gap: 6px;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        /* Enhanced Messages */
        .message {
            display: flex;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            opacity: 0;
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 12px;
            box-shadow: var(--logo-glow);
            transition: transform 0.3s ease;
        }

        .message-avatar:hover {
            transform: scale(1.1);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .message.ai .message-avatar {
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
        }

        .message-content {
            flex: 1;
            max-width: calc(100% - 40px);
        }

        .message-bubble {
            background-color: var(--message-ai-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background-color: var(--message-user-bg);
            border-color: rgba(255, 107, 53, 0.2);
        }

        .message-timestamp {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Enhanced Message Actions */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .message-action:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .message-action.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* Enhanced Formatted Content */
        .formatted-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--copilot-text);
        }

        .formatted-content p {
            margin-bottom: 16px;
        }

        .formatted-content p:last-child {
            margin-bottom: 0;
        }

        .formatted-content h1, .formatted-content h2, .formatted-content h3, 
        .formatted-content h4, .formatted-content h5, .formatted-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .formatted-content h1 { 
            font-size: 1.75em; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
        }
        .formatted-content h2 { 
            font-size: 1.5em; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 6px; 
        }
        .formatted-content h3 { 
            font-size: 1.25em; 
        }
        .formatted-content h4 { 
            font-size: 1.1em; 
        }

        .formatted-content ul, .formatted-content ol {
            margin-left: 24px;
            margin-bottom: 16px;
        }

        .formatted-content li {
            margin-bottom: 8px;
        }

        .formatted-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .formatted-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .formatted-content em {
            font-style: italic;
        }

        .formatted-content code {
            background-color: var(--hover-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--accent-color);
        }

        /* Enhanced Code Blocks */
        .code-block {
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .code-block:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .code-header {
            background-color: var(--code-header-bg);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--code-header-border);
        }

        .code-language {
            font-size: 12px;
            color: var(--aj-gold);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .language-icon {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            display: inline-block;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-btn {
            background: var(--code-action-bg);
            border: 1px solid var(--code-header-border);
            color: var(--code-text);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .code-btn:hover {
            background: var(--code-action-hover);
            border-color: var(--code-text);
        }

        .code-content {
            padding: 16px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: var(--code-text);
            background-color: var(--code-bg);
            max-height: 400px;
            overflow-y: auto;
        }

        .code-content::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .code-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .code-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .code-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Tables */
        .table-container {
            margin: 16px 0;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .data-table th {
            background-color: var(--hover-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table td {
            color: var(--text-secondary);
        }

        /* Enhanced Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background-color: var(--message-ai-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-secondary);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-tertiary);
            animation: typingDots 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typingDots {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Enhanced Input Area */
        .input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 120px;
            font-family: inherit;
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .attach-btn, .voice-btn, .send-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attach-btn:hover, .voice-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .send-btn {
            background-color: var(--accent-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .send-btn:hover {
            background-color: #e55a30;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Drag and Drop */
        .drag-over {
            background-color: rgba(255, 107, 53, 0.1);
            border-color: var(--accent-color);
        }

        .file-drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 107, 53, 0.1);
            border: 2px dashed var(--accent-color);
            border-radius: var(--border-radius);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .file-drop-zone.active {
            display: flex;
        }

        .file-drop-icon {
            font-size: 48px;
            color: var(--accent-color);
        }

        .file-drop-text {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Enhanced Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 24px;
            color: white;
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
            box-shadow: var(--logo-glow);
            transition: transform 0.3s ease;
        }

        .empty-state-icon:hover {
            transform: scale(1.05);
        }

        .empty-state h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .suggestion-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            width: 100%;
        }

        .suggestion-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-card:hover {
            background-color: var(--hover-bg);
            border-color: var(--accent-color);
        }

        .suggestion-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .suggestion-card p {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Enhanced Settings Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            border-radius: var(--modal-border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--aj-gold), #ff8c61);
            color: white;
            border-top-left-radius: var(--modal-border-radius);
            border-top-right-radius: var(--modal-border-radius);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background-color: var(--accent-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .select-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .select-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }

        /* Enhanced Toast notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #4caf50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .toast.error {
            border-color: #f44336;
            background-color: rgba(244, 67, 54, 0.1);
        }

        .toast.info {
            border-color: #2196f3;
            background-color: rgba(33, 150, 243, 0.1);
        }

        .toast.warning {
            border-color: #ff9800;
            background-color: rgba(255, 152, 0, 0.1);
        }

        /* Enhanced Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-left: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #999;
        }

        .status-dot.online {
            background-color: #4caf50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .status-dot.offline {
            background-color: #f44336;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.3);
        }

        /* Enhanced Corporate styling */
        .corporate-header {
            background-color: var(--corporate-blue);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .corporate-header i {
            font-size: 16px;
        }

        .corporate-badge {
            background-color: var(--corporate-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        /* Enhanced Proactive Suggestions */
        .proactive-suggestions {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 300px;
            background-color: var(--proactive-bg);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .proactive-suggestions.hidden {
            transform: translateX(320px);
        }

        .proactive-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .proactive-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .proactive-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .proactive-item {
            padding: 8px;
            background-color: var(--secondary-bg);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .proactive-item:hover {
            background-color: var(--hover-bg);
        }

        /* Enhanced Collaboration Panel */
        .collaboration-panel {
            position: fixed;
            top: 60px;
            right: 0;
            width: 300px;
            height: calc(100vh - 60px);
            background-color: var(--collaboration-bg);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1500;
        }

        .collaboration-panel.active {
            transform: translateX(0);
        }

        .collaboration-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collaboration-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .collaboration-content {
            padding: 16px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .collaboration-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .collaboration-user.active {
            background-color: var(--hover-bg);
        }

        .collaboration-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .collaboration-info {
            flex: 1;
        }

        .collaboration-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .collaboration-status {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* Enhanced Analytics Dashboard */
        .analytics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .analytics-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .analytics-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .analytics-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .analytics-change {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .analytics-change.positive {
            color: #4caf50;
        }

        .analytics-change.negative {
            color: #f44336;
        }

        .chart-container {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .chart-container h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* Enhanced File Upload */
        .file-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background-color: var(--hover-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-size {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-remove:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        /* Enhanced Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 1000;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                width: 100%;
            }

            .chat-container {
                padding: 16px;
            }

            .input-area {
                padding: 16px;
            }

            .suggestion-cards {
                grid-template-columns: 1fr;
            }

            .sidebar-right {
                width: 100%;
                position: fixed;
                right: -100%;
                top: 0;
                height: 100vh;
                z-index: 999;
                transition: right 0.3s ease;
            }

            .sidebar-right.active {
                right: 0;
            }

            .message {
                max-width: 100%;
            }

            .message-content {
                max-width: calc(100% - 32px);
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 12px;
            }

            .header-actions {
                gap: 4px;
            }

            .header-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .model-selector, .tone-selector {
                padding: 4px 8px;
                font-size: 11px;
            }

            .header-title h1 {
                font-size: 14px;
            }

            .header-subtitle {
                font-size: 10px;
            }

            .status-indicator {
                font-size: 10px;
            }

            .toast {
                left: 16px;
                right: 16px;
                bottom: 16px;
            }

            .proactive-suggestions {
                width: calc(100% - 32px);
                right: 16px;
                left: 16px;
            }

            .collaboration-panel {
                width: 100%;
            }

            .analytics-dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced Tablet Responsive */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .sidebar-right {
                width: 280px;
            }

            .chat-container {
                padding: 18px;
            }

            .message {
                max-width: 90%;
            }

            .analytics-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Enhanced Large Desktop Responsive */
        @media (min-width: 1440px) {
            .sidebar {
                width: 280px;
            }

            .sidebar-right {
                width: 320px;
            }

            .message {
                max-width: 900px;
            }

            .chat-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .analytics-dashboard {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Enhanced Ultra-wide Responsive */
        @media (min-width: 1920px) {
            .sidebar {
                width: 320px;
            }

            .sidebar-right {
                width: 400px;
            }

            .message {
                max-width: 1000px;
            }

            .chat-container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .analytics-dashboard {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Enhanced Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        /* Enhanced Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: var(--text-primary);
            color: var(--primary-bg);
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Enhanced Login Page -->
    <div id="loginPage" class="login-page">
        <div class="spotlight"></div>

        <div class="vault-container">
            <input type="checkbox" id="vault-toggle">
            
            <label for="vault-toggle" class="vault-door">
                <div class="door-face front">
                    <div class="locking-bar horizontal"></div>
                    <div class="locking-bar horizontal"></div>
                    <div class="locking-bar vertical"></div>
                    <div class="locking-bar vertical"></div>

                    <div class="vault-handle">
                        <div class="handle-ring"></div>
                        <div class="handle-center"></div>
                    </div>
                </div>
                <div class="door-face back"></div>
            </label>
            
            <div class="login-form-container">
                <h1 class="login-title">AJ STUDIOZ</h1>
                <h2>ADVANCED AGENTIC AI</h2>
                <p>Secure access to next-generation AI capabilities</p>
                <form id="loginForm">
                    <div class="input-group">
                        <input type="email" id="emailInput" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="passwordInput" placeholder="Password" required>
                    </div>
                    <button type="submit" class="login-button">
                        <i class="fas fa-lock"></i> Authenticate
                    </button>
                </form>
                
                <button id="googleLoginBtn" class="google-login-button">
                    <i class="fab fa-google"></i>
                    Sign in with Google
                </button>
                
                <button id="microsoftLoginBtn" class="google-login-button" style="background: #0078d4; margin-top: 8px;">
                    <i class="fab fa-microsoft"></i>
                    Sign in with Microsoft
                </button>
                
                <div class="signup-link">
                    Don't have an account? <a href="#" id="signupLink">Sign up</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Main App -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- Enhanced Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text">STUDIOZ</div>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>
            
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search conversations..." onkeyup="searchConversations(this.value)">
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- Chat history items will be added dynamically -->
            </div>
            
            <div class="project-section">
                <div class="project-header">
                    <span>Projects</span>
                    <i class="fas fa-plus" style="cursor: pointer; font-size: 12px;" onclick="createNewProject()"></i>
                </div>
                <div id="projectList">
                    <!-- Project items will be added dynamically -->
                </div>
            </div>
            
            <div class="project-section">
                <div class="project-header">
                    <span>Agents</span>
                    <i class="fas fa-cog" style="cursor: pointer; font-size: 12px;" onclick="openAgentSettings()"></i>
                </div>
                <div id="agentList">
                    <!-- Agent status items will be added dynamically -->
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile" onclick="openSettings()">
                    <div class="user-avatar" id="userAvatar">K</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Karthik</div>
                        <div class="user-status" id="userStatus">Pro Plan</div>
                    </div>
                    <i class="fas fa-cog" style="color: var(--text-tertiary);"></i>
                </div>
            </div>
        </div>

        <!-- Enhanced Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="header-title">
                    <div class="ai-avatar"></div>
                    <div>
                        <h1>AJ STUDIOZ Advanced AI</h1>
                        <div class="header-subtitle">Multi-Agent Agentic Intelligence System</div>
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot online" id="statusDot"></span>
                        <span id="statusText">Online</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <select class="model-selector" onchange="changeModel(this.value)">
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                        <option value="claude-3-opus">Claude 3 Opus</option>
                        <option value="claude-3-haiku">Claude 3 Haiku</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    </select>
                    
                    <select class="tone-selector" onchange="changeTone(this.value)">
                        <option value="professional">Professional</option>
                        <option value="casual">Casual</option>
                        <option value="friendly">Friendly</option>
                        <option value="analytical">Analytical</option>
                        <option value="creative">Creative</option>
                    </select>
                    
                    <button class="header-btn" onclick="toggleCollaboration()">
                        <i class="fas fa-users"></i>
                    </button>
                    
                    <button class="header-btn" onclick="toggleAnalytics()">
                        <i class="fas fa-chart-bar"></i>
                    </button>
                    
                    <button class="header-btn" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <button class="header-btn" onclick="clearChat()">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                    
                    <button class="header-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <button class="header-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Enhanced Agent Status Bar -->
            <div class="agent-status-bar">
                <div class="agent-status-item">
                    <span class="agent-status-indicator" id="codeAgentStatus"></span>
                    <span>Code Agent</span>
                </div>
                <div class="agent-status-item">
                    <span class="agent-status-indicator" id="researchAgentStatus"></span>
                    <span>Research Agent</span>
                </div>
                <div class="agent-status-item">
                    <span class="agent-status-indicator" id="creativeAgentStatus"></span>
                    <span>Creative Agent</span>
                </div>
                <div class="agent-status-item">
                    <span class="agent-status-indicator" id="analysisAgentStatus"></span>
                    <span>Analysis Agent</span>
                </div>
                <div class="agent-status-item">
                    <span class="agent-status-indicator" id="orchestratorStatus"></span>
                    <span>Orchestrator</span>
                </div>
            </div>

            <div class="quota-usage">
                <div class="quota-usage-bar" id="quotaBar" style="width: 65%;"></div>
            </div>

            <div class="upgrade-banner" id="upgradeBanner" style="display: none;">
                <span>Upgrade to Enterprise for unlimited agents and advanced features</span>
                <button onclick="upgradePlan()">Upgrade Now</button>
            </div>

            <div class="chat-layout">
                <div class="chat-container" id="chatContainer">
                    <!-- Enhanced Empty State -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon"></div>
                        <h2>Welcome to Advanced Agentic AI</h2>
                        <p>I'm equipped with multiple specialized agents, proactive intelligence, and advanced capabilities. How can I assist you today?</p>
                        
                        <div class="suggestion-cards">
                            <div class="suggestion-card" onclick="sendSuggestion('Create a full-stack web application with React and Node.js')">
                                <h3>🚀 Full-Stack Development</h3>
                                <p>Build complete applications with multiple agents</p>
                            </div>
                            <div class="suggestion-card" onclick="sendSuggestion('Analyze this dataset and create predictive models')">
                                <h3>📊 Data Science & ML</h3>
                                <p>Advanced analysis and machine learning</p>
                            </div>
                            <div class="suggestion-card" onclick="sendSuggestion('Create a comprehensive business strategy document')">
                                <h3>📈 Business Strategy</h3>
                                <p>Strategic planning and analysis</p>
                            </div>
                            <div class="suggestion-card" onclick="sendSuggestion('Design a multi-modal AI system architecture')">
                                <h3>🤖 AI System Design</h3>
                                <p>Advanced AI architecture and planning</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Right Sidebar -->
                <div class="sidebar-right" id="sidebarRight">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" onclick="switchTab('preview')">Preview</button>
                        <button class="sidebar-tab" onclick="switchTab('tools')">Tools</button>
                        <button class="sidebar-tab" onclick="switchTab('agents')">Agents</button>
                        <button class="sidebar-tab" onclick="switchTab('memory')">Memory</button>
                    </div>
                    
                    <div class="tab-content active" id="preview-tab">
                        <div class="preview-container">
                            <div class="preview-header">
                                <span>Live Preview</span>
                                <div class="preview-actions">
                                    <button class="code-btn" onclick="refreshPreview()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button class="code-btn" onclick="openInNewTab()">
                                        <i class="fas fa-external-link-alt"></i> Open
                                    </button>
                                </div>
                            </div>
                            <iframe id="previewFrame" class="preview-content" sandbox="allow-scripts"></iframe>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tools-tab">
                        <div class="tools-container">
                            <h3>Available Tools</h3>
                            <div class="tool-list" id="toolList">
                                <!-- Tools will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="agents-tab">
                        <div class="agents-container">
                            <h3>Active Agents</h3>
                            <div class="agent-status-list" id="agentStatusList">
                                <!-- Agent status will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="memory-tab">
                        <div class="memory-container">
                            <h3>Memory Context</h3>
                            <div class="memory-stats" id="memoryStats">
                                <!-- Memory statistics will be populated dynamically -->
                            </div>
                            <div class="memory-history" id="memoryHistory">
                                <!-- Memory history will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper" id="inputWrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Message Advanced AI..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        <div class="input-actions">
                            <button class="attach-btn" onclick="attachFile()" title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="voice-btn" onclick="startVoiceInput()" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="attach-btn" onclick="toggleProactiveMode()" title="Proactive mode">
                                <i class="fas fa-brain"></i>
                            </button>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled title="Send message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enhanced File Drop Zone -->
                    <div class="file-drop-zone" id="fileDropZone">
                        <i class="fas fa-cloud-upload-alt file-drop-icon"></i>
                        <div class="file-drop-text">Drop files here to upload</div>
                        <div class="file-drop-subtitle">Supports documents, images, audio, video, code, and data files</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Advanced Settings</h2>
                <button class="modal-close" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Account & Security</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Email</div>
                            <div class="setting-description" id="userEmail">karthik@example.com</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Plan</div>
                            <div class="setting-description" id="userPlan">Pro Plan</div>
                        </div>
                        <button class="header-btn" onclick="upgradePlan()">Upgrade</button>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Two-Factor Authentication</div>
                            <div class="setting-description">Add an extra layer of security</div>
                        </div>
                        <div class="toggle-switch" id="twoFactorToggle" onclick="toggleTwoFactor()"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Agent Configuration</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Multi-Agent Orchestration</div>
                            <div class="setting-description">Enable advanced agent collaboration</div>
                        </div>
                        <div class="toggle-switch active" id="agentOrchestrationToggle" onclick="toggleAgentOrchestration()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Proactive Intelligence</div>
                            <div class="setting-description">AI anticipates your needs</div>
                        </div>
                        <div class="toggle-switch active" id="proactiveToggle" onclick="toggleProactiveIntelligence()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Autonomous Workflows</div>
                            <div class="setting-description">Allow agents to work independently</div>
                        </div>
                        <div class="toggle-switch" id="autonomousToggle" onclick="toggleAutonomousWorkflows()"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Memory & Context</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Enhanced Memory</div>
                            <div class="setting-description">Long-term conversation memory</div>
                        </div>
                        <div class="toggle-switch active" id="memoryToggle" onclick="toggleMemory()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Context Window</div>
                            <div class="setting-description">Maximum context size (tokens)</div>
                        </div>
                        <select class="select-input" onchange="changeContextWindow(this.value)">
                            <option value="4000">4K (Standard)</option>
                            <option value="8000">8K (Extended)</option>
                            <option value="16000">16K (Large)</option>
                            <option value="32000">32K (Maximum)</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Interface Preferences</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Dark Mode</div>
                            <div class="setting-description">Toggle dark theme</div>
                        </div>
                        <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Default Tone</div>
                            <div class="setting-description">Set default response tone</div>
                        </div>
                        <select class="select-input" onchange="changeDefaultTone(this.value)">
                            <option value="professional">Professional</option>
                            <option value="casual">Casual</option>
                            <option value="friendly">Friendly</option>
                            <option value="analytical">Analytical</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Data & Privacy</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Conversation History</div>
                            <div class="setting-description">Save chat history</div>
                        </div>
                        <div class="toggle-switch active" id="historyToggle" onclick="toggleHistory()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Data Usage for Improvement</div>
                            <div class="setting-description">Help improve AI performance</div>
                        </div>
                        <div class="toggle-switch" id="dataToggle" onclick="toggleDataUsage()"></div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Data Export</div>
                            <div class="setting-description">Download your data</div>
                        </div>
                        <button class="header-btn" onclick="exportData()">Export</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Analytics Modal -->
    <div class="modal" id="analyticsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Analytics Dashboard</h2>
                <button class="modal-close" onclick="closeAnalytics()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="analytics-dashboard">
                    <div class="analytics-card">
                        <h3>Total Conversations</h3>
                        <div class="analytics-value" id="totalConversations">0</div>
                        <div class="analytics-change positive">+12% from last week</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Messages Processed</h3>
                        <div class="analytics-value" id="messagesProcessed">0</div>
                        <div class="analytics-change positive">+8% from last week</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Agent Utilization</h3>
                        <div class="analytics-value" id="agentUtilization">0%</div>
                        <div class="analytics-change negative">-2% from last week</div>
                    </div>
                    <div class="analytics-card">
                        <h3>User Satisfaction</h3>
                        <div class="analytics-value" id="userSatisfaction">0%</div>
                        <div class="analytics-change positive">+5% from last week</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Conversation Activity</h3>
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Agent Performance</h3>
                    <canvas id="agentChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Proactive Suggestions Panel -->
    <div class="proactive-suggestions hidden" id="proactiveSuggestions">
        <div class="proactive-header">
            <div class="proactive-title">
                <i class="fas fa-lightbulb"></i>
                Smart Suggestions
            </div>
            <button class="proactive-close" onclick="toggleProactivePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="proactiveContent">
            <!-- Proactive suggestions will be populated dynamically -->
        </div>
    </div>

    <!-- Enhanced Collaboration Panel -->
    <div class="collaboration-panel" id="collaborationPanel">
        <div class="collaboration-header">
            <div class="collaboration-title">
                <i class="fas fa-users"></i>
                Collaboration
            </div>
            <button class="proactive-close" onclick="toggleCollaboration()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="collaboration-content">
            <div class="collaboration-section">
                <h4>Active Users</h4>
                <div id="activeUsers">
                    <!-- Active users will be populated dynamically -->
                </div>
            </div>
            <div class="collaboration-section">
                <h4>Shared Sessions</h4>
                <div id="sharedSessions">
                    <!-- Shared sessions will be populated dynamically -->
                </div>
            </div>
            <div class="collaboration-section">
                <h4>Real-time Activity</h4>
                <div id="realtimeActivity">
                    <!-- Real-time activity will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Toast notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Message sent successfully!</span>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_i3zb-WpmYOz1oJuwYaKvYAFivaNTXQQ",
            authDomain: "aj-06-318af.firebaseapp.com",
            projectId: "aj-06-318af",
            storageBucket: "aj-06-318af.firebasestorage.app",
            messagingSenderId: "888538013305",
            appId: "1:888538013305:web:40f028b0b93018e24d7ea8",
            measurementId: "G-WFYVZNBYSV"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize highlight.js
        hljs.highlightAll();
        
        // Enhanced API Configuration
        const API_CONFIG = {
            endpoint: '/api/chat',
            endpoints: {
                chat: '/api/chat',
                agents: '/api/agents',
                tools: '/api/tools',
                memory: '/api/memory',
                analytics: '/api/analytics',
                collaboration: '/api/collaboration'
            },
            headers: {
                'Content-Type': 'application/json',
                'X-API-Version': 'v2'
            }
        };
        
        // Enhanced Global State Management
        const state = {
            auth: {
                user: null,
                session: 'active',
                role: 'user',
                permissions: [],
                mfaEnabled: false
            },
            chat: {
                activeSession: null,
                messages: [],
                contextWindow: [],
                pendingMessages: [],
                hasMessages: false,
                currentChatId: null,
                sessionId: uuidv4(),
                threadId: null
            },
            agents: {
                orchestrator: {
                    id: 'orchestrator',
                    name: 'Orchestrator Agent',
                    status: 'online',
                    model: 'claude-3-opus',
                    capabilities: ['planning', 'coordination', 'decision_making']
                },
                specialized: {
                    code: {
                        id: 'code_agent',
                        name: 'Code Agent',
                        status: 'online',
                        model: 'claude-3-sonnet',
                        specialty: 'code_generation',
                        capabilities: ['coding', 'debugging', 'code_review', 'testing']
                    },
                    research: {
                        id: 'research_agent',
                        name: 'Research Agent',
                        status: 'online',
                        model: 'claude-3-haiku',
                        specialty: 'information_retrieval',
                        capabilities: ['web_search', 'data_analysis', 'fact_checking', 'summarization']
                    },
                    creative: {
                        id: 'creative_agent',
                        name: 'Creative Agent',
                        status: 'online',
                        model: 'claude-3-opus',
                        specialty: 'creative_content',
                        capabilities: ['writing', 'design', 'brainstorming', 'storytelling']
                    },
                    analysis: {
                        id: 'analysis_agent',
                        name: 'Analysis Agent',
                        status: 'online',
                        model: 'claude-3-sonnet',
                        specialty: 'data_analysis',
                        capabilities: ['data_processing', 'statistics', 'visualization', 'pattern_recognition']
                    }
                },
                workflows: {
                    sequential: ['research', 'analysis', 'creation'],
                    concurrent: ['code', 'documentation', 'testing'],
                    evaluatorOptimizer: ['generate', 'evaluate', 'refine'],
                    orchestratorWorkers: ['plan', 'delegate', 'synthesize']
                }
            },
            ui: {
                modals: { 
                    settings: false, 
                    analytics: false, 
                    billing: false,
                    agentSettings: false
                },
                theme: 'light',
                sidebarOpen: false,
                rightSidebarOpen: false,
                activeTab: 'preview',
                proactivePanelOpen: false,
                collaborationPanelOpen: false
            },
            memory: {
                working: {
                    capacity: 10000,
                    data: [],
                    retention: 'session'
                },
                shortTerm: {
                    capacity: 50000,
                    data: [],
                    retention: '7_days',
                    compression: true
                },
                longTerm: {
                    capacity: 'unlimited',
                    data: [],
                    retention: 'permanent',
                    indexing: 'vector'
                },
                episodic: {
                    data: [],
                    emotionalContext: {},
                    importanceScores: {}
                }
            },
            tools: {
                available: {
                    codeExecution: {
                        name: 'code_executor',
                        description: 'Execute code in various languages',
                        parameters: ['code', 'language', 'timeout'],
                        safetyChecks: ['sandbox', 'resource_limits'],
                        enabled: true
                    },
                    webSearch: {
                        name: 'web_search',
                        description: 'Search the web for current information',
                        parameters: ['query', 'max_results', 'time_range'],
                        rateLimits: { requests_per_minute: 10 },
                        enabled: true
                    },
                    dataVisualization: {
                        name: 'data_viz',
                        description: 'Create charts and graphs from data',
                        parameters: ['data', 'chart_type', 'options'],
                        outputFormats: ['png', 'svg', 'interactive_html'],
                        enabled: true
                    },
                    fileProcessing: {
                        name: 'file_processor',
                        description: 'Process and analyze uploaded files',
                        parameters: ['file', 'analysis_type'],
                        supportedFormats: ['pdf', 'docx', 'txt', 'csv', 'json', 'images'],
                        enabled: true
                    }
                },
                active: [],
                usage: {}
            },
            proactive: {
                enabled: true,
                predictions: [],
                suggestions: [],
                userPatterns: {},
                contextAwareness: true
            },
            collaboration: {
                enabled: false,
                sessions: {},
                activeUsers: [],
                sharedContext: {},
                realtimeUpdates: true
            },
            analytics: {
                metrics: {
                    conversations: 0,
                    messages: 0,
                    agentUsage: {},
                    responseTimes: [],
                    userSatisfaction: [],
                    systemHealth: {}
                },
                insights: {
                    patterns: [],
                    recommendations: [],
                    trends: []
                }
            },
            multiModal: {
                supported: ['text', 'image', 'audio', 'video'],
                active: ['text'],
                processors: {
                    image: null,
                    audio: null,
                    video: null
                }
            },
            quota: {
                used: 65,
                total: 100,
                messagesLeft: 35,
                agentCalls: 1000,
                toolUsage: {}
            },
            api: {
                status: 'online',
                lastCheck: null,
                endpoints: {}
            },
            code: {
                current: '',
                language: 'html',
                preview: '',
                execution: {
                    enabled: true,
                    sandbox: true,
                    timeout: 5000
                }
            },
            security: {
                encryption: {
                    atRest: true,
                    inTransit: true,
                    endToEnd: false
                },
                audit: {
                    enabled: true,
                    logLevel: 'info'
                },
                compliance: {
                    gdpr: true,
                    ccpa: true,
                    hipaa: false
                }
            }
        };
        
        // Enhanced DOM elements
        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const emptyState = document.getElementById('emptyState');
        const sidebar = document.getElementById('sidebar');
        const sidebarRight = document.getElementById('sidebarRight');
        const toast = document.getElementById('toast');
        const fileDropZone = document.getElementById('fileDropZone');
        const inputWrapper = document.getElementById('inputWrapper');
        const settingsModal = document.getElementById('settingsModal');
        const analyticsModal = document.getElementById('analyticsModal');
        const upgradeBanner = document.getElementById('upgradeBanner');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const previewFrame = document.getElementById('previewFrame');
        const proactiveSuggestions = document.getElementById('proactiveSuggestions');
        const collaborationPanel = document.getElementById('collaborationPanel');
        
        // Enhanced Login form elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const microsoftLoginBtn = document.getElementById('microsoftLoginBtn');
        const signupLink = document.getElementById('signupLink');
        
        // Enhanced User profile elements
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userStatus = document.getElementById('userStatus');
        const userEmail = document.getElementById('userEmail');
        const userPlan = document.getElementById('userPlan');
        
        // Enhanced Spotlight effect for login page
        const spotlight = document.querySelector('.spotlight');
        document.addEventListener('mousemove', (e) => {
            if (loginPage.style.display !== 'none') {
                const { clientX, clientY } = e;
                const x = (clientX / window.innerWidth) * 100;
                const y = (clientY / window.innerHeight) * 100;
                spotlight.style.background = `radial-gradient(circle at ${x}% ${y}%, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0) 40%)`;
            }
        });
        
        // Enhanced Authentication state observer
        auth.onAuthStateChanged(async user => {
            if (user) {
                state.auth.user = user;
                await initializeUserSession(user);
                showMainApp();
                updateUserProfile(user);
                await initializeAdvancedFeatures();
                loadUserConversations();
                startAgentMonitoring();
                startProactiveEngine();
            } else {
                state.auth.user = null;
                showLoginPage();
                stopAdvancedFeatures();
            }
        });
        
        // Enhanced Show login page
        function showLoginPage() {
            loginPage.style.display = 'flex';
            mainApp.style.display = 'none';
        }
        
        // Enhanced Show main app
        function showMainApp() {
            loginPage.style.display = 'none';
            mainApp.style.display = 'flex';
            initializeApp();
        }
        
        // Enhanced Initialize user session
        async function initializeUserSession(user) {
            try {
                state.chat.sessionId = uuidv4();
                state.chat.threadId = uuidv4();
                
                // Load user preferences from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    state.auth.permissions = userData.permissions || [];
                    state.auth.role = userData.role || 'user';
                    state.auth.mfaEnabled = userData.mfaEnabled || false;
                    state.ui.theme = userData.theme || 'light';
                    state.proactive.enabled = userData.proactiveEnabled !== false;
                    state.agents.workflows = userData.agentWorkflows || state.agents.workflows;
                }
                
                // Initialize user-specific data
                await initializeUserData(user.uid);
                
            } catch (error) {
                console.error('Error initializing user session:', error);
                showToast('Session initialization failed', 'error');
            }
        }
        
        // Enhanced Update user profile
        function updateUserProfile(user) {
            if (user.displayName) {
                userName.textContent = user.displayName;
                userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
            } else {
                userName.textContent = 'User';
                userAvatar.textContent = 'U';
            }
            
            userEmail.textContent = user.email;
            
            // Check user plan and update UI accordingly
            if (state.auth.role === 'enterprise') {
                userStatus.textContent = 'Enterprise Plan';
                userPlan.textContent = 'Enterprise Plan';
                upgradeBanner.style.display = 'none';
            } else if (state.auth.role === 'pro') {
                userStatus.textContent = 'Pro Plan';
                userPlan.textContent = 'Pro Plan';
                upgradeBanner.style.display = 'none';
            } else {
                userStatus.textContent = 'Free Plan';
                userPlan.textContent = 'Free Plan';
                upgradeBanner.style.display = 'flex';
            }
        }
        
        // Enhanced Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Check if MFA is enabled
                if (state.auth.mfaEnabled) {
                    await verifyMFA(userCredential.user);
                }
                
                showToast('Login successful!', 'success');
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                showToast(`Login failed: ${errorMessage}`, 'error');
            }
        });
        
        // Enhanced Google sign-in
        googleLoginBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showToast('Google sign-in successful!', 'success');
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                showToast(`Google sign-in failed: ${errorMessage}`, 'error');
            }
        });
        
        // Enhanced Microsoft sign-in
        microsoftLoginBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.OAuthProvider('microsoft.com');
                const result = await auth.signInWithPopup(provider);
                showToast('Microsoft sign-in successful!', 'success');
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                showToast(`Microsoft sign-in failed: ${errorMessage}`, 'error');
            }
        });
        
        // Enhanced Sign up link
        signupLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = prompt('Enter your email address:');
            if (email) {
                const password = prompt('Create a password:');
                if (password) {
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // Initialize user data in Firestore
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            role: 'free',
                            permissions: ['basic_chat', 'file_upload'],
                            mfaEnabled: false,
                            theme: 'light',
                            proactiveEnabled: true,
                            agentWorkflows: state.agents.workflows
                        });
                        
                        showToast('Account created successfully!', 'success');
                    } catch (error) {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        showToast(`Sign up failed: ${errorMessage}`, 'error');
                    }
                }
            }
        });
        
        // Enhanced Logout
        async function logout() {
            try {
                // Save session data before logout
                await saveSessionData();
                
                await auth.signOut();
                showToast('Logged out successfully!', 'success');
            } catch (error) {
                showToast('Logout failed: ' + error.message, 'error');
            }
        }
        
        // Enhanced Initialize app
        function initializeApp() {
            messageInput.focus();
            updateQuotaBar();
            setupDragAndDrop();
            initializeAgentStatus();
            initializeToolList();
            initializeMemoryStats();
            
            // Apply user theme
            if (state.ui.theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').classList.add('active');
            }
            
            // Check if user is on free plan
            if (state.auth.role === 'free') {
                upgradeBanner.style.display = 'flex';
            } else {
                upgradeBanner.style.display = 'none';
            }
        }
        
        // Enhanced Initialize advanced features
        async function initializeAdvancedFeatures() {
            try {
                // Initialize multi-modal processors
                await initializeMultiModalProcessors();
                
                // Initialize collaboration system
                if (state.collaboration.enabled) {
                    await initializeCollaborationSystem();
                }
                
                // Initialize analytics collection
                initializeAnalyticsCollection();
                
                // Initialize proactive engine
                if (state.proactive.enabled) {
                    initializeProactiveEngine();
                }
                
                // Load user memory
                await loadUserMemory();
                
                // Initialize security monitoring
                initializeSecurityMonitoring();
                
                showToast('Advanced features initialized', 'success');
            } catch (error) {
                console.error('Error initializing advanced features:', error);
                showToast('Some advanced features failed to initialize', 'warning');
            }
        }
        
        // Enhanced Stop advanced features
        function stopAdvancedFeatures() {
            // Stop all background processes
            if (state.proactive.engine) {
                clearInterval(state.proactive.engine);
            }
            
            if (state.collaboration.websocket) {
                state.collaboration.websocket.close();
            }
            
            if (state.analytics.collection) {
                clearInterval(state.analytics.collection);
            }
            
            // Clear memory
            state.memory.working.data = [];
            state.memory.shortTerm.data = [];
            
            // Reset agent statuses
            Object.values(state.agents.specialized).forEach(agent => {
                agent.status = 'offline';
            });
            
            updateAgentStatus();
        }
        
        // Enhanced setupEventListeners
        function setupEventListeners() {
            // Enhanced keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === '/' && document.activeElement !== messageInput) {
                    e.preventDefault();
                    messageInput.focus();
                }
                if (e.key === 'Escape') {
                    closeSettings();
                    closeAnalytics();
                    if (state.ui.sidebarOpen) toggleSidebar();
                }
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    document.querySelector('.search-input').focus();
                }
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    startNewChat();
                }
            });
            
            // Enhanced window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('open');
                }
                
                // Update responsive layouts
                updateResponsiveLayouts();
            });
            
            // Enhanced close sidebar when clicking outside
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('open') && 
                    !sidebar.contains(event.target) && 
                    !event.target.closest('.header-btn')) {
                    sidebar.classList.remove('open');
                }
            });
            
            // Enhanced online/offline detection
            window.addEventListener('online', () => {
                updateConnectionStatus('online');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus('offline');
            });
            
            // Enhanced visibility change detection
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Pause non-essential processes
                    pauseBackgroundProcesses();
                } else {
                    // Resume processes
                    resumeBackgroundProcesses();
                }
            });
        }
        
        // Enhanced Load user conversations from Firestore
        async function loadUserConversations() {
            if (!state.auth.user) return;
            
            try {
                const conversationsRef = db.collection('users').doc(state.auth.user.uid).collection('conversations');
                const snapshot = await conversationsRef.orderBy('updatedAt', 'desc').limit(20).get();
                
                const chatHistory = document.getElementById('chatHistory');
                chatHistory.innerHTML = '';
                
                if (snapshot.empty) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'chat-history-item';
                    emptyItem.innerHTML = '<i class="fas fa-inbox"></i><span>No conversations yet</span>';
                    emptyItem.style.color = 'var(--text-tertiary)';
                    emptyItem.style.cursor = 'default';
                    chatHistory.appendChild(emptyItem);
                    return;
                }
                
                snapshot.forEach(doc => {
                    const conversation = doc.data();
                    const historyItem = document.createElement('div');
                    historyItem.className = 'chat-history-item';
                    historyItem.innerHTML = `
                        <i class="fas fa-message"></i>
                        <span>${conversation.title || 'Untitled Conversation'}</span>
                        <span class="corporate-badge">${conversation.messagesCount || 0} msgs</span>
                        ${conversation.agentUsed ? `<span class="corporate-badge" style="background-color: var(--aj-green);">${conversation.agentUsed}</span>` : ''}
                    `;
                    historyItem.onclick = () => loadConversation(doc.id, conversation);
                    chatHistory.appendChild(historyItem);
                });
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                showToast('Failed to load conversations', 'error');
            }
        }
        
        // Enhanced Save conversation to Firestore
        async function saveConversation() {
            if (!state.auth.user || state.chat.messages.length === 0) return;
            
            try {
                const conversationRef = db.collection('users').doc(state.auth.user.uid).collection('conversations');
                
                // Get first user message as title
                const firstUserMessage = state.chat.messages.find(msg => msg.type === 'user');
                const title = firstUserMessage ? firstUserMessage.content.substring(0, 50) + (firstUserMessage.content.length > 50 ? '...' : '') : 'Untitled Conversation';
                
                // Determine which agents were used
                const agentsUsed = [...new Set(state.chat.messages
                    .filter(msg => msg.type === 'ai' && msg.agent)
                    .map(msg => msg.agent))];
                
                const conversationData = {
                    title: title,
                    messages: state.chat.messages,
                    messagesCount: state.chat.messages.length,
                    agentsUsed: agentsUsed.join(', '),
                    sessionId: state.chat.sessionId,
                    threadId: state.chat.threadId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    metadata: {
                        duration: calculateConversationDuration(),
                        toolsUsed: Object.keys(state.tools.usage),
                        satisfaction: calculateUserSatisfaction()
                    }
                };
                
                if (state.chat.currentChatId) {
                    await conversationRef.doc(state.chat.currentChatId).update(conversationData);
                } else {
                    const docRef = await conversationRef.add(conversationData);
                    state.chat.currentChatId = docRef.id;
                }
                
                // Update analytics
                updateConversationAnalytics(conversationData);
                
                // Refresh conversation list
                loadUserConversations();
                
            } catch (error) {
                console.error('Error saving conversation:', error);
                showToast('Failed to save conversation', 'error');
            }
        }
        
        // Enhanced Load a specific conversation
        async function loadConversation(conversationId, conversationData) {
            try {
                // Clear current chat
                state.chat.messages = [];
                state.chat.currentChatId = conversationId;
                state.chat.sessionId = conversationData.sessionId || uuidv4();
                state.chat.threadId = conversationData.threadId || uuidv4();
                
                // Hide empty state
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
                
                // Enable two-column layout
                if (!state.chat.hasMessages) {
                    state.chat.hasMessages = true;
                    sidebarRight.classList.add('active');
                }
                
                // Load messages with enhanced formatting
                chatContainer.innerHTML = '';
                for (const msg of conversationData.messages) {
                    await addMessage(msg.type, msg.content, false, msg.agent, msg.metadata);
                }
                
                // Highlight as active
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                // Restore context if available
                if (conversationData.context) {
                    await restoreConversationContext(conversationData.context);
                }
                
                showToast('Conversation loaded', 'success');
                
            } catch (error) {
                console.error('Error loading conversation:', error);
                showToast('Failed to load conversation', 'error');
            }
        }
        
        // Enhanced loadSampleData
        function loadSampleData() {
            // Load sample projects
            const sampleProjects = [
                { id: 1, title: "Web Development", icon: 'fas fa-code', progress: 75 },
                { id: 2, title: "AI Research", icon: 'fas fa-brain', progress: 60 },
                { id: 3, title: "Data Analysis", icon: 'fas fa-chart-line', progress: 90 },
                { id: 4, title: "Content Creation", icon: 'fas fa-pen', progress: 45 }
            ];
            
            const projectList = document.getElementById('projectList');
            sampleProjects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'project-item';
                projectItem.innerHTML = `
                    <i class="${project.icon}"></i>
                    <div style="flex: 1;">
                        <span>${project.title}</span>
                        <div style="width: 100%; height: 4px; background-color: var(--border-color); border-radius: 2px; margin-top: 4px;">
                            <div style="width: ${project.progress}%; height: 100%; background-color: var(--aj-gold); border-radius: 2px;"></div>
                        </div>
                    </div>
                `;
                projectItem.onclick = () => loadProject(project.id);
                projectList.appendChild(projectItem);
            });
            
            // Initialize agent status list
            updateAgentStatus();
        }
        
        // Enhanced Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            sendBtn.disabled = !textarea.value.trim();
            
            // Trigger proactive suggestions based on input
            if (state.proactive.enabled) {
                triggerProactiveSuggestions(textarea.value);
            }
        }
        
        // Enhanced Handle keyboard shortcuts
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendBtn.disabled) {
                    sendMessage();
                }
            }
            
            // Enhanced keyboard shortcuts for agent selection
            if (event.ctrlKey && event.key >= '1' && event.key <= '5') {
                event.preventDefault();
                const agentIndex = parseInt(event.key) - 1;
                const agents = Object.values(state.agents.specialized);
                if (agents[agentIndex]) {
                    selectAgent(agents[agentIndex].id);
                }
            }
        }
        
        // Enhanced Send message with multi-agent orchestration
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || state.chat.pendingMessages.length > 0) return;
            
            // Check quota
            if (state.quota.messagesLeft <= 0) {
                showToast('Message quota exceeded. Please upgrade your plan.', 'error');
                return;
            }
            
            // Check API status
            if (state.api.status !== 'online') {
                showToast('AI is currently offline. Please try again later.', 'error');
                return;
            }
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendBtn.disabled = true;
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Add user message with enhanced metadata
            const userMessage = {
                type: 'user',
                content: message,
                timestamp: new Date().toISOString(),
                metadata: {
                    sessionId: state.chat.sessionId,
                    threadId: state.chat.threadId,
                    intent: await analyzeIntent(message),
                    complexity: calculateComplexity(message),
                    language: detectLanguage(message)
                }
            };
            
            await addMessage(userMessage.type, userMessage.content, true, null, userMessage.metadata);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Enable two-column layout after first message
            if (!state.chat.hasMessages) {
                state.chat.hasMessages = true;
                sidebarRight.classList.add('active');
            }
            
            // Add to pending messages
            state.chat.pendingMessages.push(message);
            
            // Process message with agent orchestration
            await processMessageWithAgents(message, userMessage.metadata);
        }
        
        // Enhanced Process message with multi-agent orchestration
        async function processMessageWithAgents(message, metadata) {
            try {
                // Start timing for analytics
                const startTime = Date.now();
                
                // Select optimal agent(s) based on message analysis
                const selectedAgents = await selectOptimalAgents(message, metadata);
                
                // Determine workflow type
                const workflowType = determineWorkflow(selectedAgents, metadata);
                
                let response;
                
                if (workflowType === 'sequential') {
                    response = await executeSequentialWorkflow(message, selectedAgents);
                } else if (workflowType === 'concurrent') {
                    response = await executeConcurrentWorkflow(message, selectedAgents);
                } else if (workflowType === 'orchestrator') {
                    response = await executeOrchestratorWorkflow(message, selectedAgents);
                } else {
                    // Single agent response
                    response = await executeSingleAgentResponse(message, selectedAgents[0]);
                }
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Add AI response with enhanced metadata
                const aiResponse = {
                    type: 'ai',
                    content: response.content,
                    timestamp: new Date().toISOString(),
                    agent: response.agent,
                    metadata: {
                        ...response.metadata,
                        processingTime: Date.now() - startTime,
                        agentsUsed: selectedAgents.map(a => a.id),
                        workflowType: workflowType,
                        confidence: response.confidence,
                        toolsUsed: response.toolsUsed || []
                    }
                };
                
                await addMessageWithTypingEffect(aiResponse.type, aiResponse.content, aiResponse.agent, aiResponse.metadata);
                
                // Extract code from response if available
                if (response.content.includes('```')) {
                    extractCodeFromResponse(response.content);
                }
                
                // Update quota and analytics
                updateQuotaAndAnalytics(selectedAgents, response.toolsUsed || [], Date.now() - startTime);
                
                // Update memory
                await updateConversationMemory(message, response.content, selectedAgents);
                
                // Remove from pending messages
                state.chat.pendingMessages = state.chat.pendingMessages.filter(msg => msg !== message);
                
                // Save conversation
                await saveConversation();
                
                // Trigger proactive suggestions
                if (state.proactive.enabled) {
                    triggerProactiveActions(message, response.content);
                }
                
                showToast('Response generated successfully!', 'success');
                
            } catch (error) {
                console.error('Error processing message with agents:', error);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Show error message
                const errorMessage = {
                    type: 'ai',
                    content: 'I apologize, but I encountered an error while processing your request. This might be due to agent coordination issues. Please try again.',
                    timestamp: new Date().toISOString(),
                    metadata: {
                        error: error.message,
                        fallback: true
                    }
                };
                
                await addMessage(errorMessage.type, errorMessage.content, true, null, errorMessage.metadata);
                showToast('Failed to generate response: ' + error.message, 'error');
                
                // Remove from pending messages
                state.chat.pendingMessages = state.chat.pendingMessages.filter(msg => msg !== message);
            }
        }
        
        // Enhanced Select optimal agents based on message analysis
        async function selectOptimalAgents(message, metadata) {
            const agents = Object.values(state.agents.specialized);
            const scores = {};
            
            // Score each agent based on message content and metadata
            for (const agent of agents) {
                scores[agent.id] = await calculateAgentScore(agent, message, metadata);
            }
            
            // Sort agents by score
            const sortedAgents = agents.sort((a, b) => scores[b.id] - scores[a.id]);
            
            // Select top agents based on complexity and requirements
            if (metadata.complexity === 'high') {
                return sortedAgents.slice(0, 3); // Use top 3 agents for complex tasks
            } else if (metadata.complexity === 'medium') {
                return sortedAgents.slice(0, 2); // Use top 2 agents for medium tasks
            } else {
                return [sortedAgents[0]]; // Use best agent for simple tasks
            }
        }
        
        // Enhanced Calculate agent score
        async function calculateAgentScore(agent, message, metadata) {
            let score = 0;
            
            // Base score based on agent capabilities
            score += agent.capabilities.length * 10;
            
            // Intent matching
            if (metadata.intent && agent.specialty) {
                const intentMatch = calculateIntentMatch(metadata.intent, agent.specialty);
                score += intentMatch * 50;
            }
            
            // Keyword matching
            const keywords = extractKeywords(message);
            const keywordMatches = keywords.filter(keyword => 
                agent.capabilities.some(capability => 
                    capability.toLowerCase().includes(keyword.toLowerCase())
                )
            ).length;
            score += keywordMatches * 20;
            
            // Agent performance history
            const agentPerformance = getAgentPerformance(agent.id);
            score += agentPerformance.successRate * 30;
            
            // Load balancing (consider current agent load)
            const agentLoad = getAgentLoad(agent.id);
            score -= agentLoad * 10;
            
            // Random factor for exploration
            score += Math.random() * 5;
            
            return score;
        }
        
        // Enhanced Execute sequential workflow
        async function executeSequentialWorkflow(message, agents) {
            const results = [];
            let currentInput = message;
            
            for (const agent of agents) {
                try {
                    const agentResult = await callAgent(agent, currentInput, {
                        workflow: 'sequential',
                        step: agents.indexOf(agent) + 1,
                        totalSteps: agents.length,
                        previousResults: results
                    });
                    
                    results.push({
                        agent: agent.id,
                        result: agentResult,
                        timestamp: Date.now()
                    });
                    
                    currentInput = agentResult.content;
                    
                } catch (error) {
                    console.error(`Error in sequential workflow with agent ${agent.id}:`, error);
                    // Continue with next agent or fallback
                    if (results.length === 0) {
                        throw new Error('Sequential workflow failed on first agent');
                    }
                }
            }
            
            // Synthesize final response
            const synthesizedResponse = await synthesizeResults(results, 'sequential');
            
            return {
                content: synthesizedResponse.content,
                agent: 'workflow_sequential',
                metadata: {
                    workflowType: 'sequential',
                    agents: agents.map(a => a.id),
                    steps: results.length,
                    synthesis: synthesizedResponse.method
                },
                confidence: synthesizedResponse.confidence,
                toolsUsed: results.flatMap(r => r.result.toolsUsed || [])
            };
        }
        
        // Enhanced Execute concurrent workflow
        async function executeConcurrentWorkflow(message, agents) {
            const promises = agents.map(async (agent) => {
                try {
                    const result = await callAgent(agent, message, {
                        workflow: 'concurrent',
                        agents: agents.map(a => a.id)
                    });
                    
                    return {
                        agent: agent.id,
                        result,
                        timestamp: Date.now(),
                        success: true
                    };
                } catch (error) {
                    console.error(`Error in concurrent workflow with agent ${agent.id}:`, error);
                    return {
                        agent: agent.id,
                        error: error.message,
                        timestamp: Date.now(),
                        success: false
                    };
                }
            });
            
            const results = await Promise.all(promises);
            
            // Filter successful results
            const successfulResults = results.filter(r => r.success);
            
            if (successfulResults.length === 0) {
                throw new Error('Concurrent workflow failed: all agents failed');
            }
            
            // Synthesize results
            const synthesizedResponse = await synthesizeResults(successfulResults, 'concurrent');
            
            return {
                content: synthesizedResponse.content,
                agent: 'workflow_concurrent',
                metadata: {
                    workflowType: 'concurrent',
                    agents: agents.map(a => a.id),
                    successfulAgents: successfulResults.length,
                    totalAgents: agents.length,
                    synthesis: synthesizedResponse.method
                },
                confidence: synthesizedResponse.confidence,
                toolsUsed: successfulResults.flatMap(r => r.result.toolsUsed || [])
            };
        }
        
        // Enhanced Execute orchestrator workflow
        async function executeOrchestratorWorkflow(message, availableAgents) {
            // First, call orchestrator to plan the task
            const orchestrator = state.agents.orchestrator;
            
            const plan = await callAgent(orchestrator, message, {
                workflow: 'orchestrator',
                availableAgents: availableAgents.map(a => a.id),
                task: 'plan_and_execute'
            });
            
            // Parse the plan to determine required agents and steps
            const executionPlan = parseExecutionPlan(plan.content);
            
            // Execute the plan
            const executionResults = [];
            
            for (const step of executionPlan.steps) {
                const agent = availableAgents.find(a => a.id === step.agent);
                if (!agent) {
                    console.warn(`Agent ${step.agent} not found for step ${step.id}`);
                    continue;
                }
                
                try {
                    const stepResult = await callAgent(agent, step.input, {
                        workflow: 'orchestrator',
                        stepId: step.id,
                        planId: executionPlan.id,
                        context: {
                            previousResults: executionResults,
                            plan: executionPlan
                        }
                    });
                    
                    executionResults.push({
                        stepId: step.id,
                        agent: agent.id,
                        result: stepResult,
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    console.error(`Error executing step ${step.id} with agent ${agent.id}:`, error);
                    executionResults.push({
                        stepId: step.id,
                        agent: agent.id,
                        error: error.message,
                        timestamp: Date.now()
                    });
                }
            }
            
            // Final synthesis by orchestrator
            const finalSynthesis = await callAgent(orchestrator, {
                originalMessage: message,
                plan: executionPlan,
                results: executionResults
            }, {
                workflow: 'orchestrator',
                task: 'synthesize_results'
            });
            
            return {
                content: finalSynthesis.content,
                agent: 'workflow_orchestrator',
                metadata: {
                    workflowType: 'orchestrator',
                    orchestrator: orchestrator.id,
                    planId: executionPlan.id,
                    steps: executionPlan.steps.length,
                    completedSteps: executionResults.filter(r => !r.error).length,
                    synthesis: 'orchestrator_final'
                },
                confidence: finalSynthesis.confidence || 0.8,
                toolsUsed: executionResults.flatMap(r => r.result?.toolsUsed || [])
            };
        }
        
        // Enhanced Execute single agent response
        async function executeSingleAgentResponse(message, agent) {
            const result = await callAgent(agent, message, {
                workflow: 'single'
            });
            
            return {
                content: result.content,
                agent: agent.id,
                metadata: {
                    workflowType: 'single',
                    agent: agent.id
                },
                confidence: result.confidence || 0.7,
                toolsUsed: result.toolsUsed || []
            };
        }
        
        // Enhanced Call individual agent
        async function callAgent(agent, input, context = {}) {
            const agentStart = Date.now();
            
            try {
                // Update agent status to busy
                updateAgentStatus(agent.id, 'busy');
                
                // Prepare agent-specific context
                const agentContext = {
                    ...context,
                    agent: {
                        id: agent.id,
                        name: agent.name,
                        capabilities: agent.capabilities,
                        specialty: agent.specialty
                    },
                    user: {
                        id: state.auth.user.uid,
                        preferences: getUserPreferences(),
                        history: getRelevantHistory(agent.specialty)
                    },
                    session: {
                        id: state.chat.sessionId,
                        threadId: state.chat.threadId
                    },
                    tools: getAvailableToolsForAgent(agent)
                };
                
                // Make API call to agent
                const response = await fetch(API_CONFIG.endpoints.agents, {
                    method: 'POST',
                    headers: API_CONFIG.headers,
                    body: JSON.stringify({
                        agent: agent.id,
                        input,
                        context: agentContext,
                        model: agent.model,
                        options: {
                            temperature: getTemperatureForAgent(agent),
                            maxTokens: getMaxTokensForAgent(agent),
                            tools: agentContext.tools
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Agent ${agent.id} request failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Process agent response
                const processedResult = {
                    content: result.content,
                    confidence: result.confidence || 0.7,
                    toolsUsed: result.toolsUsed || [],
                    processingTime: Date.now() - agentStart,
                    metadata: result.metadata || {}
                };
                
                // Update agent performance metrics
                updateAgentPerformance(agent.id, processedResult);
                
                return processedResult;
                
            } catch (error) {
                console.error(`Error calling agent ${agent.id}:`, error);
                
                // Update agent performance with failure
                updateAgentPerformance(agent.id, {
                    success: false,
                    error: error.message,
                    processingTime: Date.now() - agentStart
                });
                
                throw error;
            } finally {
                // Restore agent status
                updateAgentStatus(agent.id, 'online');
            }
        }
        
        // Enhanced Synthesize results from multiple agents
        async function synthesizeResults(results, workflowType) {
            if (results.length === 1) {
                return {
                    content: results[0].result.content,
                    confidence: results[0].result.confidence || 0.7,
                    method: 'single_agent'
                };
            }
            
            // Use orchestrator to synthesize multiple results
            try {
                const synthesisInput = {
                    results: results.map(r => ({
                        agent: r.agent,
                        content: r.result.content,
                        confidence: r.result.confidence || 0.7,
                        toolsUsed: r.result.toolsUsed || []
                    })),
                    workflowType,
                    originalContext: results[0].result.context
                };
                
                const synthesis = await callAgent(state.agents.orchestrator, synthesisInput, {
                    task: 'synthesize_results',
                    workflowType
                });
                
                return {
                    content: synthesis.content,
                    confidence: synthesis.confidence || 0.8,
                    method: 'orchestrator_synthesis'
                };
                
            } catch (error) {
                console.error('Error synthesizing results:', error);
                
                // Fallback: simple concatenation with formatting
                const fallbackContent = results.map((r, index) => 
                    `**${r.agent} Analysis:**\n${r.result.content}\n\n`
                ).join('');
                
                return {
                    content: fallbackContent,
                    confidence: 0.6,
                    method: 'fallback_concatenation'
                };
            }
        }
        
        // Enhanced Add message with typing effect
        function addMessageWithTypingEffect(type, content, agent = null, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.style.opacity = '0';
            messageDiv.style.transition = 'opacity 0.5s ease-in-out';
            
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            
            const agentBadge = agent ? `<span class="corporate-badge" style="background-color: var(--aj-green);">${agent}</span>` : '';
            
            const messageActions = type === 'ai' ? `
                <div class="message-actions">
                    <button class="message-action" onclick="copyMessage(this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="message-action" onclick="regenerateMessage(this)">
                        <i class="fas fa-redo"></i> Regenerate
                    </button>
                    <button class="message-action" onclick="likeMessage(this)">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    ${agent ? `<button class="message-action" onclick="viewAgentDetails('${agent}')">
                        <i class="fas fa-info-circle"></i> Agent
                    </button>` : ''}
                </div>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${type === 'user' ? userAvatar.textContent : ''}
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="formatted-content" id="typing-content-${Date.now()}"></div>
                        ${agentBadge}
                        ${messageActions}
                    </div>
                    <div class="message-timestamp">${timestamp}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Get the content element
            const contentElement = messageDiv.querySelector('.formatted-content');
            const contentId = contentElement.id;
            
            // Start typing effect
            typeWriter(content, contentElement, 0);
            
            // Add to message history
            state.chat.messages.push({ 
                type, 
                content, 
                timestamp: new Date().toISOString(),
                agent,
                metadata 
            });
        }
        
        // Enhanced Typewriter effect
        function typeWriter(text, element, index) {
            if (index < text.length) {
                // Check if we're at a code block start
                if (text.substr(index, 3) === '```') {
                    // Find the end of the code block
                    const codeEnd = text.indexOf('```', index + 3);
                    if (codeEnd !== -1) {
                        // Extract the code block
                        const codeBlock = text.substring(index, codeEnd + 3);
                        // Add the entire code block at once
                        element.innerHTML += formatContent(codeBlock);
                        
                        // Highlight code blocks
                        element.querySelectorAll('pre code').forEach(block => {
                            hljs.highlightElement(block);
                        });
                        
                        // Continue after the code block
                        setTimeout(() => {
                            typeWriter(text, element, codeEnd + 3);
                        }, 50);
                        return;
                    }
                }
                
                // Add character by character for regular text
                element.innerHTML += text.charAt(index);
                index++;
                
                // Calculate typing speed (adaptive based on content type)
                let typingSpeed = Math.random() * 20 + 10;
                
                // Slow down for code and special content
                if (text.substr(index, 10).includes('```') || text.substr(index, 10).includes('**')) {
                    typingSpeed *= 2;
                }
                
                // Speed up for simple text
                if (text.substr(index, 20).match(/^[a-zA-Z\s,.!?]+$/)) {
                    typingSpeed *= 0.7;
                }
                
                setTimeout(() => {
                    typeWriter(text, element, index);
                }, typingSpeed);
            } else {
                // Final formatting after typing is complete
                const formattedContent = formatContent(element.innerHTML);
                element.innerHTML = formattedContent;
                
                // Highlight code blocks
                element.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
                
                // Show the message with fade-in effect
                const messageDiv = element.closest('.message');
                messageDiv.style.opacity = '1';
                
                // Trigger any post-message actions
                triggerPostMessageActions(messageDiv);
            }
        }
        
        // Enhanced Extract code from AI response
        function extractCodeFromResponse(response) {
            // Regular expression to match code blocks
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            let match;
            let codeFound = false;
            
            while ((match = codeBlockRegex.exec(response)) !== null) {
                const language = match[1] || 'text';
                const code = match[2];
                
                // Update the code in the state
                state.code.current = code;
                state.code.language = language;
                
                // If it's HTML, also update the preview
                if (language === 'html') {
                    updatePreview(code);
                }
                
                // Add to tools usage
                if (!state.tools.usage.codeExecution) {
                    state.tools.usage.codeExecution = 0;
                }
                state.tools.usage.codeExecution++;
                
                codeFound = true;
            }
        }
        
        // Enhanced Update preview in the sidebar
        function updatePreview(html) {
            previewFrame.srcdoc = html;
            state.code.preview = html;
            
            // Add a small delay to ensure the iframe loads properly
            setTimeout(() => {
                try {
                    if (previewFrame.contentDocument && previewFrame.contentDocument.body) {
                        console.log('Preview updated successfully');
                    }
                } catch (e) {
                    console.log('Preview update error:', e);
                }
            }, 100);
        }
        
        // Enhanced Check API status
        async function checkApiStatus() {
            try {
                const endpoints = Object.keys(API_CONFIG.endpoints);
                const statusChecks = endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(API_CONFIG.endpoints[endpoint], {
                            method: 'POST',
                            headers: API_CONFIG.headers,
                            body: JSON.stringify({ ping: true })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.pong || data.status === 'ok') {
                                return { endpoint, status: 'online' };
                            }
                        }
                        return { endpoint, status: 'offline' };
                    } catch (error) {
                        return { endpoint, status: 'offline' };
                    }
                });
                
                const results = await Promise.all(statusChecks);
                const onlineEndpoints = results.filter(r => r.status === 'online');
                
                if (onlineEndpoints.length === endpoints.length) {
                    state.api.status = 'online';
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'Online';
                } else if (onlineEndpoints.length > 0) {
                    state.api.status = 'degraded';
                    statusDot.className = 'status-dot busy';
                    statusText.textContent = 'Degraded';
                } else {
                    state.api.status = 'offline';
                    statusDot.className = 'status-dot offline';
                    statusText.textContent = 'Offline';
                }
                
                // Update endpoint status
                state.api.endpoints = results.reduce((acc, r) => {
                    acc[r.endpoint] = r.status;
                    return acc;
                }, {});
                
                state.api.lastCheck = new Date();
                
            } catch (error) {
                console.error('Error checking API status:', error);
                state.api.status = 'offline';
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Offline';
            }
        }
        
        // Enhanced Copy code to clipboard
        function copyCode() {
            if (!state.code.current) {
                showToast('No code to copy', 'error');
                return;
            }
            
            navigator.clipboard.writeText(state.code.current).then(() => {
                showToast('Code copied to clipboard!', 'success');
                
                // Update analytics
                if (!state.tools.usage.copyCode) {
                    state.tools.usage.copyCode = 0;
                }
                state.tools.usage.copyCode++;
            }).catch(err => {
                showToast('Failed to copy code', 'error');
            });
        }
        
        // Enhanced Download code
        function downloadCode() {
            if (!state.code.current) {
                showToast('No code to download', 'error');
                return;
            }
            
            const extension = state.code.language === 'html' ? 'html' : 
                             state.code.language === 'css' ? 'css' : 
                             state.code.language === 'javascript' ? 'js' : 'txt';
            
            const blob = new Blob([state.code.current], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aj-studioz-code.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Code downloaded!', 'success');
            
            // Update analytics
            if (!state.tools.usage.downloadCode) {
                state.tools.usage.downloadCode = 0;
            }
            state.tools.usage.downloadCode++;
        }
        
        // Enhanced Refresh preview
        function refreshPreview() {
            if (state.code.language === 'html' && state.code.current) {
                updatePreview(state.code.current);
                showToast('Preview refreshed!', 'success');
            } else {
                showToast('No HTML code to preview', 'error');
            }
        }
        
        // Enhanced Open preview in new tab
        function openInNewTab() {
            if (state.code.language === 'html' && state.code.current) {
                const newWindow = window.open();
                newWindow.document.write(state.code.current);
                newWindow.document.close();
            } else {
                showToast('No HTML code to preview', 'error');
            }
        }
        
        // Enhanced Add message to chat
        async function addMessage(type, content, shouldSave = true, agent = null, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            
            const agentBadge = agent ? `<span class="corporate-badge" style="background-color: var(--aj-green);">${agent}</span>` : '';
            
            const messageActions = type === 'ai' ? `
                <div class="message-actions">
                    <button class="message-action" onclick="copyMessage(this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="message-action" onclick="regenerateMessage(this)">
                        <i class="fas fa-redo"></i> Regenerate
                    </button>
                    <button class="message-action" onclick="likeMessage(this)">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    ${agent ? `<button class="message-action" onclick="viewAgentDetails('${agent}')">
                        <i class="fas fa-info-circle"></i> Agent
                    </button>` : ''}
                </div>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${type === 'user' ? userAvatar.textContent : ''}
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${formatContent(content)}
                        ${agentBadge}
                        ${messageActions}
                    </div>
                    <div class="message-timestamp">${timestamp}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Highlight code blocks with enhanced stability
            messageDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
                
                // Add smooth scroll behavior for code blocks
                const codeBlock = block.closest('.code-block');
                if (codeBlock) {
                    codeBlock.style.scrollBehavior = 'smooth';
                    
                    // Ensure code blocks are properly formatted on mobile
                    if (window.innerWidth <= 768) {
                        const codeContent = codeBlock.querySelector('.code-content');
                        if (codeContent) {
                            codeContent.style.fontSize = '13px';
                            codeContent.style.lineHeight = '1.4';
                        }
                    }
                }
            });
            
            // Add to message history
            const messageData = { 
                type, 
                content, 
                timestamp: new Date().toISOString(),
                agent,
                metadata 
            };
            state.chat.messages.push(messageData);
            
            // Update memory systems
            await updateMemorySystems(messageData);
            
            // Save conversation if needed
            if (shouldSave) {
                await saveConversation();
            }
            
            // Trigger real-time collaboration updates
            if (state.collaboration.enabled && state.collaboration.realtimeUpdates) {
                broadcastMessageUpdate(messageData);
            }
        }
        
        // Enhanced Format message content
        function formatContent(content) {
            const tempDiv = document.createElement('div');
            tempDiv.className = 'formatted-content';
            
            // Convert markdown to HTML with enhanced features
            let formatted = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraphs if not already
            if (!formatted.startsWith('<')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            // Handle code blocks with enhanced features
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
                const lang = language || 'text';
                const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                
                // Get language color
                const langColor = getLanguageColor(lang);
                
                return `
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">
                                <span class="language-icon" style="background-color: ${langColor}"></span>
                                ${lang}
                            </span>
                            <div class="code-actions">
                                <button class="code-btn" onclick="copyCodeFromBlock('${codeId}')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="code-btn" onclick="runCodeFromBlock('${codeId}', '${lang}')">
                                    <i class="fas fa-play"></i> Run
                                </button>
                                <button class="code-btn" onclick="downloadCodeFromBlock('${codeId}', '${lang}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div class="code-content">
                            <pre id="${codeId}"><code class="language-${lang}">${escapeHtml(code.trim())}</code></pre>
                        </div>
                    </div>
                `;
            });
            
            // Handle tables with enhanced styling
            formatted = formatted.replace(/\|(.+)\|\n\|[-\|]+\|\n((\|.+\|\n)+)/g, (match, header, body) => {
                const headers = header.split('|').map(h => h.trim()).filter(h => h);
                const rows = body.trim().split('\n').map(row => 
                    row.split('|').map(cell => cell.trim()).filter(cell => cell)
                );
                
                let tableHTML = '<div class="table-container"><table class="data-table"><thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                rows.forEach(row => {
                    tableHTML += '<tr>';
                    row.forEach(cell => {
                        tableHTML += `<td>${cell}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            });
            
            // Handle lists
            formatted = formatted.replace(/^[\s]*-[\s]+(.*$)/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Handle blockquotes
            formatted = formatted.replace(/^[\s]*>[\s]+(.*$)/gm, '<blockquote>$1</blockquote>');
            
            // Handle mentions and hashtags
            formatted = formatted.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
            formatted = formatted.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
            
            tempDiv.innerHTML = formatted;
            return tempDiv.outerHTML;
        }
        
        // Enhanced Get language color
        function getLanguageColor(language) {
            const colors = {
                'javascript': 'var(--javascript-color)',
                'js': 'var(--javascript-color)',
                'python': 'var(--python-color)',
                'py': 'var(--python-color)',
                'html': 'var(--html-color)',
                'css': 'var(--css-color)',
                'typescript': 'var(--typescript-color)',
                'ts': 'var(--typescript-color)',
                'java': 'var(--java-color)',
                'cpp': 'var(--cpp-color)',
                'c++': 'var(--cpp-color)',
                'json': 'var(--json-color)',
                'markdown': 'var(--markdown-color)',
                'md': 'var(--markdown-color)',
                'sql': 'var(--sql-color)',
                'shell': 'var(--shell-color)',
                'bash': 'var(--shell-color)',
                'yaml': 'var(--yaml-color)',
                'yml': 'var(--yaml-color)',
                'xml': 'var(--xml-color)'
            };
            
            return colors[language.toLowerCase()] || 'var(--aj-gold)';
        }
        
        // Enhanced Escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Enhanced Copy code from a specific code block
        function copyCodeFromBlock(codeId) {
            const codeElement = document.getElementById(codeId);
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard!', 'success');
                
                // Update analytics
                if (!state.tools.usage.copyCode) {
                    state.tools.usage.copyCode = 0;
                }
                state.tools.usage.copyCode++;
            }).catch(err => {
                showToast('Failed to copy code', 'error');
            });
        }
        
        // Enhanced Run code from a specific code block
        function runCodeFromBlock(codeId, language) {
            const codeElement = document.getElementById(codeId);
            const code = codeElement.textContent;
            
            if (language === 'html' || language === 'htmlmixed') {
                updatePreview(code);
                showToast('Code executed in preview pane!', 'success');
            } else if (language === 'javascript' || language === 'js') {
                try {
                    eval(code);
                    showToast('JavaScript code executed!', 'success');
                } catch (error) {
                    showToast('Error executing JavaScript: ' + error.message, 'error');
                }
            } else if (language === 'css') {
                const styleElement = document.createElement('style');
                styleElement.textContent = code;
                document.head.appendChild(styleElement);
                showToast('CSS applied to page!', 'success');
            } else if (language === 'python') {
                showToast('Python execution requires backend support', 'info');
            } else {
                showToast('Cannot execute ' + language + ' code', 'error');
            }
            
            // Update analytics
            if (!state.tools.usage.executeCode) {
                state.tools.usage.executeCode = 0;
            }
            state.tools.usage.executeCode++;
        }
        
        // Enhanced Download code from a specific code block
        function downloadCodeFromBlock(codeId, language) {
            const codeElement = document.getElementById(codeId);
            const code = codeElement.textContent;
            
            const extension = language === 'html' ? 'html' : 
                             language === 'css' ? 'css' : 
                             language === 'javascript' || language === 'js' ? 'js' : 
                             language === 'python' || language === 'py' ? 'py' : 'txt';
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aj-studioz-code.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Code downloaded!', 'success');
            
            // Update analytics
            if (!state.tools.usage.downloadCode) {
                state.tools.usage.downloadCode = 0;
            }
            state.tools.usage.downloadCode++;
        }
        
        // Enhanced Copy message content
        function copyMessage(button) {
            const messageBubble = button.closest('.message-bubble');
            const content = messageBubble.textContent.replace('CopyRegenerateAgent', '').trim();
            
            navigator.clipboard.writeText(content).then(() => {
                showToast('Message copied to clipboard!', 'success');
            }).catch(err => {
                showToast('Failed to copy message', 'error');
            });
        }
        
        // Enhanced Regenerate message
        function regenerateMessage(button) {
            const messageDiv = button.closest('.message.ai');
            const userMessage = state.chat.messages.find(msg => msg.type === 'user');
            
            if (userMessage) {
                messageDiv.remove();
                sendMessage();
            }
        }
        
        // Enhanced Like message
        function likeMessage(button) {
            button.classList.toggle('active');
            if (button.classList.contains('active')) {
                button.style.color = 'var(--accent-color)';
                showToast('Thanks for your feedback!', 'success');
                
                // Update user satisfaction analytics
                const messageDiv = button.closest('.message');
                const messageId = messageDiv.dataset.messageId;
                if (messageId) {
                    updateMessageFeedback(messageId, 'positive');
                }
            } else {
                button.style.color = '';
                
                // Remove feedback
                const messageDiv = button.closest('.message');
                const messageId = messageDiv.dataset.messageId;
                if (messageId) {
                    updateMessageFeedback(messageId, 'neutral');
                }
            }
        }
        
        // Enhanced Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <i class="fas fa-robot" style="margin-right: 8px;"></i>
                        <span>AI Agents are thinking</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Enhanced Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Enhanced Send suggestion
        function sendSuggestion(suggestion) {
            messageInput.value = suggestion;
            autoResize(messageInput);
            sendMessage();
        }
        
        // Enhanced Start new chat
        function startNewChat() {
            // Save current conversation before starting new one
            if (state.chat.messages.length > 0) {
                saveConversation();
            }
            
            chatContainer.innerHTML = `
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon"></div>
                    <h2>Welcome to Advanced Agentic AI</h2>
                    <p>I'm equipped with multiple specialized agents, proactive intelligence, and advanced capabilities. How can I assist you today?</p>
                    
                    <div class="suggestion-cards">
                        <div class="suggestion-card" onclick="sendSuggestion('Create a full-stack web application with React and Node.js')">
                            <h3>🚀 Full-Stack Development</h3>
                            <p>Build complete applications with multiple agents</p>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('Analyze this dataset and create predictive models')">
                            <h3>📊 Data Science & ML</h3>
                            <p>Advanced analysis and machine learning</p>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('Create a comprehensive business strategy document')">
                            <h3>📈 Business Strategy</h3>
                            <p>Strategic planning and analysis</p>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('Design a multi-modal AI system architecture')">
                            <h3>🤖 AI System Design</h3>
                            <p>Advanced AI architecture and planning</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Reset chat state
            state.chat.messages = [];
            state.chat.hasMessages = false;
            state.chat.currentChatId = null;
            state.chat.sessionId = uuidv4();
            state.chat.threadId = uuidv4();
            
            // Clear working memory
            state.memory.working.data = [];
            
            // Reset UI
            sidebarRight.classList.remove('active');
            messageInput.focus();
            
            // Remove active state from chat history
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Reset code state
            state.code.current = '';
            state.code.language = 'html';
            state.code.preview = '';
            
            showToast('New chat started', 'success');
        }
        
        // Enhanced Clear chat
        function clearChat() {
            if (confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
                startNewChat();
                showToast('Chat cleared successfully!', 'success');
            }
        }
        
        // Enhanced Toggle sidebar (mobile)
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            state.ui.sidebarOpen = !state.ui.sidebarOpen;
        }
        
        // Enhanced Search conversations
        function searchConversations(query) {
            const items = document.querySelectorAll('.chat-history-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Enhanced Create new project
        function createNewProject() {
            const projectName = prompt('Enter project name:');
            if (projectName) {
                const projectList = document.getElementById('projectList');
                const projectItem = document.createElement('div');
                projectItem.className = 'project-item';
                projectItem.innerHTML = `
                    <i class="fas fa-folder"></i>
                    <div style="flex: 1;">
                        <span>${projectName}</span>
                        <div style="width: 100%; height: 4px; background-color: var(--border-color); border-radius: 2px; margin-top: 4px;">
                            <div style="width: 0%; height: 100%; background-color: var(--aj-gold); border-radius: 2px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
                projectItem.onclick = () => loadProject(projectName);
                projectList.appendChild(projectItem);
                showToast('Project created successfully!', 'success');
            }
        }
        
        // Enhanced Load chat
        function loadChat(chatId) {
            console.log('Loading chat:', chatId);
            // Implement chat loading logic
        }
        
        // Enhanced Load project
        function loadProject(projectId) {
            console.log('Loading project:', projectId);
            // Implement project loading logic
        }
        
        // Enhanced Change model
        function changeModel(model) {
            console.log('Model changed to:', model);
            
            // Update default model for orchestrator
            state.agents.orchestrator.model = model;
            
            showToast(`Model changed to ${model}`, 'success');
        }
        
        // Enhanced Change tone
        function changeTone(tone) {
            state.preferences.tone = tone;
            console.log('Tone changed to:', tone);
            showToast(`Tone changed to ${tone}`, 'success');
        }
        
        // Enhanced Change default tone
        function changeDefaultTone(tone) {
            state.preferences.tone = tone;
            console.log('Default tone changed to:', tone);
            showToast(`Default tone changed to ${tone}`, 'success');
            
            // Save to user preferences
            if (state.auth.user) {
                db.collection('users').doc(state.auth.user.uid).update({
                    defaultTone: tone
                });
            }
        }
        
        // Enhanced Toggle theme
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                state.ui.theme = 'light';
                themeToggle.classList.remove('active');
            } else {
                body.setAttribute('data-theme', 'dark');
                state.ui.theme = 'dark';
                themeToggle.classList.add('active');
            }
            
            showToast(`Theme changed to ${state.ui.theme} mode`, 'success');
            
            // Save theme preference
            if (state.auth.user) {
                db.collection('users').doc(state.auth.user.uid).update({
                    theme: state.ui.theme
                });
            }
        }
        
        // Enhanced Toggle memory
        function toggleMemory() {
            const memoryToggle = document.getElementById('memoryToggle');
            state.memory.enabled = !state.memory.enabled;
            memoryToggle.classList.toggle('active');
            showToast(`Memory ${state.memory.enabled ? 'enabled' : 'disabled'}`, 'success');
        }
        
        // Enhanced Toggle history
        function toggleHistory() {
            const historyToggle = document.getElementById('historyToggle');
            state.preferences.historyEnabled = !state.preferences.historyEnabled;
            historyToggle.classList.toggle('active');
            showToast(`History ${state.preferences.historyEnabled ? 'enabled' : 'disabled'}`, 'success');
        }
        
        // Enhanced Toggle data usage
        function toggleDataUsage() {
            const dataToggle = document.getElementById('dataToggle');
            state.preferences.dataUsageEnabled = !state.preferences.dataUsageEnabled;
            dataToggle.classList.toggle('active');
            showToast(`Data usage ${state.preferences.dataUsageEnabled ? 'enabled' : 'disabled'}`, 'success');
        }
        
        // Enhanced Update quota bar
        function updateQuotaBar() {
            const quotaBar = document.getElementById('quotaBar');
            const percentage = (state.quota.used / state.quota.total) * 100;
            quotaBar.style.width = `${percentage}%`;
            
            if (percentage >= 90) {
                quotaBar.style.background = 'linear-gradient(90deg, #f44336, #ff6b35)';
            } else if (percentage >= 70) {
                quotaBar.style.background = 'linear-gradient(90deg, #ff9800, #ff6b35)';
            }
        }
        
        // Enhanced Upgrade plan
        function upgradePlan() {
            // Show upgrade modal with options
            const upgradeOptions = {
                pro: {
                    name: 'Pro Plan',
                    price: '$29/month',
                    features: ['Unlimited messages', 'Advanced agents', 'Priority support', 'Extended memory']
                },
                enterprise: {
                    name: 'Enterprise Plan',
                    price: '$99/month',
                    features: ['Everything in Pro', 'Custom agents', 'API access', 'Dedicated support', 'Advanced analytics']
                }
            };
            
            let message = 'Choose your upgrade plan:\n\n';
            Object.entries(upgradeOptions).forEach(([key, plan]) => {
                message += `${key.toUpperCase()} - ${plan.name} (${plan.price})\n`;
                plan.features.forEach(feature => {
                    message += `  • ${feature}\n`;
                });
                message += '\n';
            });
            
            const choice = prompt(message + 'Enter "pro" or "enterprise" to upgrade:');
            if (choice && upgradeOptions[choice]) {
                // Process upgrade (in real app, this would integrate with payment system)
                state.auth.role = choice;
                updateUserProfile(state.auth.user);
                showToast(`Upgraded to ${upgradeOptions[choice].name}!`, 'success');
            }
        }
        
        // Enhanced Settings modal
        function openSettings() {
            settingsModal.classList.add('active');
            state.ui.modals.settings = true;
        }
        
        function closeSettings() {
            settingsModal.classList.remove('active');
            state.ui.modals.settings = false;
        }
        
        // Enhanced Analytics modal
        function toggleAnalytics() {
            analyticsModal.classList.add('active');
            state.ui.modals.analytics = true;
            loadAnalyticsData();
        }
        
        function closeAnalytics() {
            analyticsModal.classList.remove('active');
            state.ui.modals.analytics = false;
        }
        
        // Enhanced Load analytics data
        async function loadAnalyticsData() {
            try {
                // Update basic metrics
                document.getElementById('totalConversations').textContent = state.analytics.metrics.conversations;
                document.getElementById('messagesProcessed').textContent = state.analytics.metrics.messages;
                document.getElementById('agentUtilization').textContent = calculateAgentUtilization() + '%';
                document.getElementById('userSatisfaction').textContent = calculateUserSatisfaction() + '%';
                
                // Load charts
                await loadActivityChart();
                await loadAgentPerformanceChart();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Failed to load analytics', 'error');
            }
        }
        
        // Enhanced Load activity chart
        async function loadActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Generate sample data for the last 7 days
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                data.push(Math.floor(Math.random() * 50) + 10);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages',
                        data: data,
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Enhanced Load agent performance chart
        async function loadAgentPerformanceChart() {
            const ctx = document.getElementById('agentChart').getContext('2d');
            
            const agents = Object.values(state.agents.specialized);
            const labels = agents.map(a => a.name);
            const data = agents.map(a => {
                const perf = getAgentPerformance(a.id);
                return perf.successRate || Math.random() * 100;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Success Rate %',
                        data: data,
                        backgroundColor: [
                            '#ff6b35',
                            '#4caf50',
                            '#2196f3',
                            '#ff9800'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Enhanced File handling
        function setupDragAndDrop() {
            const dropZone = fileDropZone;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                inputWrapper.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                inputWrapper.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                inputWrapper.addEventListener(eventName, unhighlight, false);
            });
            
            inputWrapper.addEventListener('drop', handleDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            inputWrapper.classList.add('drag-over');
            fileDropZone.classList.add('active');
        }
        
        function unhighlight() {
            inputWrapper.classList.remove('drag-over');
            fileDropZone.classList.remove('active');
        }
        
        // Enhanced Handle drop
        async function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            await handleFiles(files);
        }
        
        // Enhanced Handle files
        async function handleFiles(files) {
            for (const file of ([...files])) {
                await uploadFile(file);
            }
        }
        
        // Enhanced Upload file
        async function uploadFile(file) {
            try {
                // Check file size limits
                const maxSize = state.auth.role === 'enterprise' ? 100 * 1024 * 1024 : // 100MB
                               state.auth.role === 'pro' ? 50 * 1024 * 1024 :     // 50MB
                               10 * 1024 * 1024;                               // 10MB
                
                if (file.size > maxSize) {
                    showToast(`File ${file.name} exceeds size limit`, 'error');
                    return;
                }
                
                // Show file preview
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                filePreview.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="file-remove" onclick="removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add file preview before input wrapper
                inputWrapper.parentNode.insertBefore(filePreview, inputWrapper);
                
                // Process file with advanced file processor
                const processingResult = await processFileWithAI(file);
                
                // Add to state
                state.docs.uploadedFiles.push({
                    file,
                    processingResult,
                    uploadTime: Date.now()
                });
                
                // Add file processing result to chat if significant
                if (processingResult.summary || processingResult.insights) {
                    const fileMessage = {
                        type: 'ai',
                        content: `I've processed your file "${file.name}". Here's what I found:\n\n${processingResult.summary || ''}\n\n${processingResult.insights ? 'Key insights:\n' + processingResult.insights.join('\n• ') : ''}`,
                        timestamp: new Date().toISOString(),
                        metadata: {
                            fileType: file.type,
                            fileSize: file.size,
                            processingTime: processingResult.processingTime,
                            confidence: processingResult.confidence
                        }
                    };
                    
                    await addMessage(fileMessage.type, fileMessage.content, true, 'file_processor', fileMessage.metadata);
                }
                
                showToast(`File "${file.name}" uploaded and processed successfully!`, 'success');
                
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast(`Failed to process file "${file.name}": ${error.message}`, 'error');
            }
        }
        
        // Enhanced Process file with AI
        async function processFileWithAI(file) {
            const startTime = Date.now();
            
            try {
                // Determine file type and appropriate processor
                const fileType = getFileType(file);
                const processor = getFileProcessor(fileType);
                
                if (!processor) {
                    throw new Error(`Unsupported file type: ${fileType}`);
                }
                
                // Process file based on type
                const result = await processor.process(file);
                
                return {
                    ...result,
                    processingTime: Date.now() - startTime,
                    fileType,
                    fileName: file.name,
                    fileSize: file.size
                };
                
            } catch (error) {
                console.error('Error processing file:', error);
                throw error;
            }
        }
        
        // Enhanced Get file type
        function getFileType(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const mimeType = file.type;
            
            if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(extension)) {
                return 'image';
            } else if (['mp3', 'wav', 'm4a', 'ogg'].includes(extension)) {
                return 'audio';
            } else if (['mp4', 'mov', 'avi', 'webm'].includes(extension)) {
                return 'video';
            } else if (['pdf'].includes(extension)) {
                return 'pdf';
            } else if (['doc', 'docx'].includes(extension)) {
                return 'document';
            } else if (['txt', 'md'].includes(extension)) {
                return 'text';
            } else if (['csv', 'json', 'xml'].includes(extension)) {
                return 'data';
            } else if (['js', 'py', 'html', 'css', 'java', 'cpp'].includes(extension)) {
                return 'code';
            } else {
                return 'unknown';
            }
        }
        
        // Enhanced Get file processor
        function getFileProcessor(fileType) {
            const processors = {
                image: {
                    process: async (file) => {
                        // For images, we'd use vision AI to analyze content
                        return {
                            summary: 'Image file detected. Visual analysis would be performed here.',
                            insights: ['Image format detected', 'File size within limits'],
                            confidence: 0.9
                        };
                    }
                },
                audio: {
                    process: async (file) => {
                        // For audio, we'd use speech-to-text and audio analysis
                        return {
                            summary: 'Audio file detected. Transcription and analysis would be performed here.',
                            insights: ['Audio format detected', 'Duration analysis available'],
                            confidence: 0.8
                        };
                    }
                },
                video: {
                    process: async (file) => {
                        // For video, we'd extract frames and analyze content
                        return {
                            summary: 'Video file detected. Frame extraction and analysis would be performed here.',
                            insights: ['Video format detected', 'Frame analysis available'],
                            confidence: 0.7
                        };
                    }
                },
                pdf: {
                    process: async (file) => {
                        // For PDFs, we'd extract text and analyze structure
                        return {
                            summary: 'PDF document processed. Text extraction and structure analysis completed.',
                            insights: ['Document structure analyzed', 'Key topics identified'],
                            confidence: 0.95
                        };
                    }
                },
                document: {
                    process: async (file) => {
                        // For documents, we'd extract text and metadata
                        return {
                            summary: 'Document processed. Content and metadata extracted successfully.',
                            insights: ['Document format recognized', 'Content structure analyzed'],
                            confidence: 0.9
                        };
                    }
                },
                text: {
                    process: async (file) => {
                        // For text files, we'd analyze content and sentiment
                        const text = await file.text();
                        const wordCount = text.split(/\s+/).length;
                        
                        return {
                            summary: `Text file processed. Contains ${wordCount} words.`,
                            insights: [
                                `Word count: ${wordCount}`,
                                'Text analysis completed',
                                'Sentiment analysis available'
                            ],
                            confidence: 0.95
                        };
                    }
                },
                data: {
                    process: async (file) => {
                        // For data files, we'd analyze structure and statistics
                        return {
                            summary: 'Data file processed. Structure and statistics analyzed.',
                            insights: ['Data format recognized', 'Statistical summary generated'],
                            confidence: 0.9
                        };
                    }
                },
                code: {
                    process: async (file) => {
                        // For code files, we'd analyze syntax and structure
                        const code = await file.text();
                        const lineCount = code.split('\n').length;
                        
                        return {
                            summary: `Code file processed. Contains ${lineCount} lines of ${file.name.split('.').pop()} code.`,
                            insights: [
                                `Language: ${file.name.split('.').pop()}`,
                                `Lines of code: ${lineCount}`,
                                'Syntax analysis completed'
                            ],
                            confidence: 0.95
                        };
                    }
                }
            };
            
            return processors[fileType];
        }
        
        // Enhanced Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Enhanced Remove file
        function removeFile(button) {
            const filePreview = button.closest('.file-preview');
            const fileName = filePreview.querySelector('.file-name').textContent;
            
            // Remove from state
            state.docs.uploadedFiles = state.docs.uploadedFiles.filter(file => file.file.name !== fileName);
            
            // Remove from DOM
            filePreview.remove();
            
            showToast('File removed', 'success');
        }
        
        // Enhanced Attach file
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.onchange = (e) => handleFiles(e.target.files);
            input.click();
        }
        
        // Enhanced Start voice input
        function startVoiceInput() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    showToast('Listening...', 'success');
                    updateAgentStatus('voice_agent', 'busy');
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    autoResize(messageInput);
                    showToast('Voice input captured!', 'success');
                    
                    // Automatically send the message if it's a complete sentence
                    if (transcript.match(/[.!?]$/)) {
                        sendMessage();
                    }
                };
                
                recognition.onerror = (event) => {
                    showToast('Voice input error: ' + event.error, 'error');
                };
                
                recognition.onend = () => {
                    updateAgentStatus('voice_agent', 'online');
                };
                
                recognition.start();
            } else {
                showToast('Voice input not supported in this browser', 'error');
            }
        }
        
        // Enhanced Show toast notification
        function showToast(message, type = 'success') {
            const toastMessage = document.getElementById('toastMessage');
            const toastElement = document.getElementById('toast');
            
            // Update icon based on type
            const icon = toastElement.querySelector('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' :
                           type === 'error' ? 'fas fa-exclamation-circle' :
                           type === 'warning' ? 'fas fa-exclamation-triangle' :
                           type === 'info' ? 'fas fa-info-circle' :
                           'fas fa-check-circle';
            
            toastMessage.textContent = message;
            toastElement.className = `toast ${type} show`;
            
            setTimeout(() => {
                toastElement.classList.remove('show');
            }, 3000);
        }
        
        // Enhanced Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSampleData();
            checkApiStatus();
            setInterval(checkApiStatus, 30000); // Check API status every 30 seconds
            
            // Initialize advanced features if user is logged in
            if (state.auth.user) {
                initializeAdvancedFeatures();
            }
        });
        
        // ===== ADVANCED FEATURE IMPLEMENTATIONS =====
        
        // Enhanced Agent status management
        function initializeAgentStatus() {
            updateAgentStatus();
            setInterval(updateAgentStatus, 5000); // Update every 5 seconds
        }
        
        function updateAgentStatus(agentId = null, status = null) {
            if (agentId && status) {
                // Update specific agent status
                const agent = state.agents.specialized[agentId] || 
                             (agentId === 'orchestrator' ? state.agents.orchestrator : null);
                if (agent) {
                    agent.status = status;
                }
                
                // Update UI
                const statusElement = document.getElementById(agentId + 'Status');
                if (statusElement) {
                    statusElement.className = `agent-status-indicator ${status}`;
                }
            } else {
                // Update all agent statuses
                Object.entries(state.agents.specialized).forEach(([id, agent]) => {
                    const statusElement = document.getElementById(id + 'Status');
                    if (statusElement) {
                        statusElement.className = `agent-status-indicator ${agent.status}`;
                    }
                });
                
                // Update orchestrator status
                const orchestratorStatus = document.getElementById('orchestratorStatus');
                if (orchestratorStatus) {
                    orchestratorStatus.className = `agent-status-indicator ${state.agents.orchestrator.status}`;
                }
            }
            
            // Update agent list in sidebar
            updateAgentList();
        }
        
        function updateAgentList() {
            const agentList = document.getElementById('agentList');
            if (!agentList) return;
            
            agentList.innerHTML = '';
            
            // Add orchestrator
            const orchestratorItem = createAgentListItem(state.agents.orchestrator);
            agentList.appendChild(orchestratorItem);
            
            // Add specialized agents
            Object.values(state.agents.specialized).forEach(agent => {
                const agentItem = createAgentListItem(agent);
                agentList.appendChild(agentItem);
            });
        }
        
        function createAgentListItem(agent) {
            const item = document.createElement('div');
            item.className = 'chat-history-item';
            item.innerHTML = `
                <span class="agent-status-indicator ${agent.status}" style="width: 8px; height: 8px; margin-right: 8px;"></span>
                <span>${agent.name}</span>
                <span class="corporate-badge" style="background-color: var(--aj-green);">${agent.status}</span>
            `;
            item.onclick = () => viewAgentDetails(agent.id);
            return item;
        }
        
        // Enhanced Tool management
        function initializeToolList() {
            updateToolList();
        }
        
        function updateToolList() {
            const toolList = document.getElementById('toolList');
            if (!toolList) return;
            
            toolList.innerHTML = '';
            
            Object.entries(state.tools.available).forEach(([key, tool]) => {
                const toolItem = document.createElement('div');
                toolItem.className = 'project-item';
                toolItem.innerHTML = `
                    <i class="fas fa-cog"></i>
                    <div style="flex: 1;">
                        <span>${tool.name}</span>
                        <div style="font-size: 11px; color: var(--text-tertiary);">${tool.description}</div>
                    </div>
                    <div class="toggle-switch ${tool.enabled ? 'active' : ''}" onclick="toggleTool('${key}')"></div>
                `;
                toolList.appendChild(toolItem);
            });
        }
        
        function toggleTool(toolKey) {
            state.tools.available[toolKey].enabled = !state.tools.available[toolKey].enabled;
            updateToolList();
            showToast(`Tool ${state.tools.available[toolKey].enabled ? 'enabled' : 'disabled'}`, 'success');
        }
        
        // Enhanced Memory management
        function initializeMemoryStats() {
            updateMemoryStats();
            setInterval(updateMemoryStats, 10000); // Update every 10 seconds
        }
        
        function updateMemoryStats() {
            const memoryStats = document.getElementById('memoryStats');
            if (!memoryStats) return;
            
            const workingUsage = (state.memory.working.data.length / state.memory.working.capacity * 100).toFixed(1);
            const shortTermUsage = (state.memory.shortTerm.data.length / state.memory.shortTerm.capacity * 100).toFixed(1);
            
            memoryStats.innerHTML = `
                <div class="analytics-card">
                    <h3>Working Memory</h3>
                    <div class="analytics-value">${workingUsage}%</div>
                    <div class="analytics-change">${state.memory.working.data.length} / ${state.memory.working.capacity} tokens</div>
                </div>
                <div class="analytics-card">
                    <h3>Short-term Memory</h3>
                    <div class="analytics-value">${shortTermUsage}%</div>
                    <div class="analytics-change">${state.memory.shortTerm.data.length} / ${state.memory.shortTerm.capacity} tokens</div>
                </div>
                <div class="analytics-card">
                    <h3>Long-term Memory</h3>
                    <div class="analytics-value">${state.memory.longTerm.data.length}</div>
                    <div class="analytics-change">items stored</div>
                </div>
            `;
        }
        
        async function updateMemorySystems(messageData) {
            try {
                // Add to working memory
                state.memory.working.data.push(messageData);
                
                // Compress working memory if needed
                if (state.memory.working.data.length > state.memory.working.capacity) {
                    await compressWorkingMemory();
                }
                
                // Add to short-term memory
                state.memory.shortTerm.data.push({
                    ...messageData,
                    compressed: await compressMessage(messageData)
                });
                
                // Add to episodic memory if significant
                if (isSignificantMessage(messageData)) {
                    state.memory.episodic.data.push({
                        ...messageData,
                        emotionalContext: analyzeEmotionalContext(messageData),
                        importanceScore: calculateImportanceScore(messageData)
                    });
                }
                
                // Update memory stats
                updateMemoryStats();
                
            } catch (error) {
                console.error('Error updating memory systems:', error);
            }
        }
        
        // Enhanced Proactive engine
        function initializeProactiveEngine() {
            if (!state.proactive.enabled) return;
            
            // Start proactive engine
            state.proactive.engine = setInterval(() => {
                generateProactiveSuggestions();
            }, 30000); // Check every 30 seconds
            
            // Initialize user patterns
            loadUserPatterns();
        }
        
        function generateProactiveSuggestions() {
            if (!state.proactive.enabled || state.chat.messages.length === 0) return;
            
            try {
                const suggestions = [];
                
                // Analyze recent conversation for patterns
                const recentMessages = state.chat.messages.slice(-5);
                const context = analyzeConversationContext(recentMessages);
                
                // Generate suggestions based on context
                if (context.includes('code') && context.includes('error')) {
                    suggestions.push({
                        type: 'debugging',
                        content: 'Would you like me to help debug this code issue?',
                        confidence: 0.8
                    });
                }
                
                if (context.includes('project') && context.includes('planning')) {
                    suggestions.push({
                        type: 'planning',
                        content: 'I can help create a detailed project plan. Would you like assistance?',
                        confidence: 0.7
                    });
                }
                
                if (context.includes('data') && context.includes('analysis')) {
                    suggestions.push({
                        type: 'analysis',
                        content: 'Need help with data analysis? I can create visualizations and insights.',
                        confidence: 0.75
                    });
                }
                
                // Update proactive suggestions
                state.proactive.suggestions = suggestions;
                updateProactivePanel();
                
            } catch (error) {
                console.error('Error generating proactive suggestions:', error);
            }
        }
        
        function updateProactivePanel() {
            const proactiveContent = document.getElementById('proactiveContent');
            if (!proactiveContent) return;
            
            proactiveContent.innerHTML = '';
            
            state.proactive.suggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'proactive-item';
                suggestionItem.innerHTML = `
                    <div>${suggestion.content}</div>
                    <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 4px;">
                        Confidence: ${Math.round(suggestion.confidence * 100)}%
                    </div>
                `;
                suggestionItem.onclick = () => {
                    sendSuggestion(suggestion.content);
                    toggleProactivePanel();
                };
                proactiveContent.appendChild(suggestionItem);
            });
            
            // Show panel if there are suggestions
            if (state.proactive.suggestions.length > 0 && state.ui.proactivePanelOpen) {
                proactiveSuggestions.classList.remove('hidden');
            }
        }
        
        function toggleProactivePanel() {
            state.ui.proactivePanelOpen = !state.ui.proactivePanelOpen;
            if (state.ui.proactivePanelOpen) {
                proactiveSuggestions.classList.remove('hidden');
                updateProactivePanel();
            } else {
                proactiveSuggestions.classList.add('hidden');
            }
        }
        
        function toggleProactiveMode() {
            state.proactive.enabled = !state.proactive.enabled;
            if (state.proactive.enabled) {
                initializeProactiveEngine();
                showToast('Proactive mode enabled', 'success');
            } else {
                if (state.proactive.engine) {
                    clearInterval(state.proactive.engine);
                }
                showToast('Proactive mode disabled', 'info');
            }
        }
        
        // Enhanced Collaboration system
        async function initializeCollaborationSystem() {
            if (!state.collaboration.enabled) return;
            
            try {
                // Initialize WebSocket connection for real-time collaboration
                state.collaboration.websocket = new WebSocket('wss://your-collaboration-server.com');
                
                state.collaboration.websocket.onopen = () => {
                    console.log('Collaboration WebSocket connected');
                    showToast('Collaboration system connected', 'success');
                };
                
                state.collaboration.websocket.onmessage = (event) => {
                    handleCollaborationMessage(JSON.parse(event.data));
                };
                
                state.collaboration.websocket.onerror = (error) => {
                    console.error('Collaboration WebSocket error:', error);
                    showToast('Collaboration system error', 'error');
                };
                
                state.collaboration.websocket.onclose = () => {
                    console.log('Collaboration WebSocket disconnected');
                    showToast('Collaboration system disconnected', 'warning');
                };
                
            } catch (error) {
                console.error('Error initializing collaboration system:', error);
                showToast('Failed to initialize collaboration system', 'error');
            }
        }
        
        function toggleCollaboration() {
            state.collaboration.enabled = !state.collaboration.enabled;
            
            if (state.collaboration.enabled) {
                initializeCollaborationSystem();
                collaborationPanel.classList.add('active');
                showToast('Collaboration enabled', 'success');
            } else {
                if (state.collaboration.websocket) {
                    state.collaboration.websocket.close();
                }
                collaborationPanel.classList.remove('active');
                showToast('Collaboration disabled', 'info');
            }
        }
        
        // Enhanced Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Update active tab state
            state.ui.activeTab = tabName;
            
            // Refresh tab content if needed
            if (tabName === 'agents') {
                updateAgentStatusList();
            } else if (tabName === 'memory') {
                updateMemoryStats();
            }
        }
        
        // Enhanced Security monitoring
        function initializeSecurityMonitoring() {
            if (!state.security.audit.enabled) return;
            
            // Start security monitoring
            setInterval(() => {
                performSecurityCheck();
            }, 60000); // Check every minute
            
            // Monitor for suspicious activities
            monitorSuspiciousActivities();
        }
        
        function performSecurityCheck() {
            // Check for unusual patterns
            const unusualPatterns = detectUnusualPatterns();
            
            if (unusualPatterns.length > 0) {
                console.warn('Unusual patterns detected:', unusualPatterns);
                // In production, this would trigger security alerts
            }
        }
        
        function monitorSuspiciousActivities() {
            // Monitor for rapid successive requests
            let requestCount = 0;
            let lastRequestTime = Date.now();
            
            const originalSend = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function(data) {
                requestCount++;
                const now = Date.now();
                
                if (requestCount > 100 && (now - lastRequestTime) < 60000) {
                    console.warn('Suspicious activity: High request rate detected');
                    // Trigger security alert
                }
                
                lastRequestTime = now;
                return originalSend.call(this, data);
            };
        }
        
        // Enhanced Analytics collection
        function initializeAnalyticsCollection() {
            // Start collecting analytics data
            state.analytics.collection = setInterval(() => {
                collectAnalyticsData();
            }, 300000); // Collect every 5 minutes
            
            // Collect initial data
            collectAnalyticsData();
        }
        
        function collectAnalyticsData() {
            try {
                // Update conversation metrics
                state.analytics.metrics.conversations = state.chat.currentChatId ? 
                    state.analytics.metrics.conversations + 1 : state.analytics.metrics.conversations;
                
                state.analytics.metrics.messages = state.chat.messages.length;
                
                // Update agent usage metrics
                Object.values(state.agents.specialized).forEach(agent => {
                    if (!state.analytics.metrics.agentUsage[agent.id]) {
                        state.analytics.metrics.agentUsage[agent.id] = 0;
                    }
                    state.analytics.metrics.agentUsage[agent.id] = getAgentUsage(agent.id);
                });
                
                // Calculate user satisfaction
                state.analytics.metrics.userSatisfaction = calculateUserSatisfaction();
                
                // Update system health
                state.analytics.metrics.systemHealth = {
                    uptime: process.uptime(),
                    memoryUsage: process.memoryUsage(),
                    apiStatus: state.api.status
                };
                
            } catch (error) {
                console.error('Error collecting analytics data:', error);
            }
        }
        
        function updateConversationAnalytics(conversationData) {
            // Update analytics based on conversation data
            state.analytics.metrics.conversations++;
            state.analytics.metrics.messages += conversationData.messagesCount;
            
            // Update agent usage
            if (conversationData.agentsUsed) {
                conversationData.agentsUsed.split(', ').forEach(agentId => {
                    if (!state.analytics.metrics.agentUsage[agentId]) {
                        state.analytics.metrics.agentUsage[agentId] = 0;
                    }
                    state.analytics.metrics.agentUsage[agentId]++;
                });
            }
        }
        
        // Enhanced Multi-modal processing
        async function initializeMultiModalProcessors() {
            try {
                // Initialize image processor
                if (state.multiModal.supported.includes('image')) {
                    state.multiModal.processors.image = await initializeImageProcessor();
                }
                
                // Initialize audio processor
                if (state.multiModal.supported.includes('audio')) {
                    state.multiModal.processors.audio = await initializeAudioProcessor();
                }
                
                // Initialize video processor
                if (state.multiModal.supported.includes('video')) {
                    state.multiModal.processors.video = await initializeVideoProcessor();
                }
                
                showToast('Multi-modal processors initialized', 'success');
                
            } catch (error) {
                console.error('Error initializing multi-modal processors:', error);
                showToast('Some multi-modal features failed to initialize', 'warning');
            }
        }
        
        async function initializeImageProcessor() {
            // In a real implementation, this would initialize vision AI models
            return {
                process: async (imageFile) => {
                    // Placeholder for image processing
                    return {
                        description: 'Image analysis would be performed here',
                        objects: [],
                        text: '',
                        confidence: 0.8
                    };
                }
            };
        }
        
        async function initializeAudioProcessor() {
            // In a real implementation, this would initialize speech-to-text models
            return {
                process: async (audioFile) => {
                    // Placeholder for audio processing
                    return {
                        transcript: 'Audio transcription would be performed here',
                        sentiment: 'neutral',
                        confidence: 0.7
                    };
                }
            };
        }
        
        async function initializeVideoProcessor() {
            // In a real implementation, this would initialize video analysis models
            return {
                process: async (videoFile) => {
                    // Placeholder for video processing
                    return {
                        description: 'Video analysis would be performed here',
                        frames: [],
                        audio: '',
                        confidence: 0.6
                    };
                }
            };
        }
        
        // Enhanced Utility functions
        
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function calculateComplexity(text) {
            const words = text.split(/\s+/).length;
            const sentences = text.split(/[.!?]+/).length;
            const avgWordsPerSentence = words / sentences;
            
            if (words > 100 && avgWordsPerSentence > 15) {
                return 'high';
            } else if (words > 50 || avgWordsPerSentence > 10) {
                return 'medium';
            } else {
                return 'low';
            }
        }
        
        function detectLanguage(text) {
            // Simple language detection (in production, use a proper library)
            const patterns = {
                spanish: /[ñáéíóúü]/i,
                french: /[àâäçéèêëïîôùûüÿœæ]/i,
                german: /[äöüß]/i,
                italian: /[àèéìòù]/i
            };
            
            for (const [lang, pattern] of Object.entries(patterns)) {
                if (pattern.test(text)) {
                    return lang;
                }
            }
            
            return 'english';
        }
        
        function analyzeIntent(text) {
            const doc = nlp(text);
            const verbs = doc.verbs().out('array');
            const nouns = doc.nouns().out('array');
            
            // Simple intent analysis
            if (verbs.some(v => ['create', 'build', 'make', 'develop'].includes(v))) {
                return 'creation';
            } else if (verbs.some(v => ['analyze', 'examine', 'study', 'investigate'].includes(v))) {
                return 'analysis';
            } else if (verbs.some(v => ['help', 'assist', 'support'].includes(v))) {
                return 'help';
            } else if (nouns.some(n => ['code', 'programming', 'development'].includes(n))) {
                return 'coding';
            } else if (nouns.some(n => ['data', 'statistics', 'analytics'].includes(n))) {
                return 'data_analysis';
            }
            
            return 'general';
        }
        
        function extractKeywords(text) {
            const doc = nlp(text);
            return doc.keywords().out('array');
        }
        
        function calculateIntentMatch(intent, specialty) {
            const intentSpecialtyMap = {
                'creation': ['creative_content', 'code_generation'],
                'analysis': ['data_analysis', 'information_retrieval'],
                'help': ['creative_content', 'information_retrieval'],
                'coding': ['code_generation'],
                'data_analysis': ['data_analysis']
            };
            
            const matchingSpecialties = intentSpecialtyMap[intent] || [];
            return matchingSpecialties.includes(specialty) ? 1 : 0;
        }
        
        function getAgentPerformance(agentId) {
            // Return cached performance or default
            return state.analytics.metrics.agentPerformance?.[agentId] || {
                successRate: 0.8,
                avgResponseTime: 1000,
                totalCalls: 0
            };
        }
        
        function getAgentLoad(agentId) {
            // Simple load calculation based on recent usage
            const recentUsage = state.analytics.metrics.agentUsage?.[agentId] || 0;
            return Math.min(recentUsage / 10, 1); // Normalize to 0-1
        }
        
        function getTemperatureForAgent(agent) {
            const temperatures = {
                'creative_agent': 0.8,
                'code_agent': 0.3,
                'research_agent': 0.5,
                'analysis_agent': 0.4,
                'orchestrator': 0.6
            };
            
            return temperatures[agent.id] || 0.5;
        }
        
        function getMaxTokensForAgent(agent) {
            const maxTokens = {
                'creative_agent': 4000,
                'code_agent': 2000,
                'research_agent': 3000,
                'analysis_agent': 3500,
                'orchestrator': 4000
            };
            
            return maxTokens[agent.id] || 2000;
        }
        
        function getAvailableToolsForAgent(agent) {
            const agentTools = {
                'code_agent': ['codeExecution', 'fileProcessing'],
                'research_agent': ['webSearch', 'fileProcessing'],
                'creative_agent': ['fileProcessing'],
                'analysis_agent': ['dataVisualization', 'fileProcessing'],
                'orchestrator': Object.keys(state.tools.available).filter(key => state.tools.available[key].enabled)
            };
            
            return agentTools[agent.id] || [];
        }
        
        function getUserPreferences() {
            return {
                theme: state.ui.theme,
                tone: state.preferences.tone,
                proactiveEnabled: state.proactive.enabled,
                language: 'english'
            };
        }
        
        function getRelevantHistory(specialty) {
            // Return relevant conversation history based on specialty
            const relevantMessages = state.chat.messages.filter(msg => {
                if (msg.type !== 'ai') return false;
                
                const content = msg.content.toLowerCase();
                switch (specialty) {
                    case 'code_generation':
                        return content.includes('code') || content.includes('function') || content.includes('class');
                    case 'data_analysis':
                        return content.includes('data') || content.includes('analysis') || content.includes('statistics');
                    case 'creative_content':
                        return content.includes('create') || content.includes('write') || content.includes('design');
                    case 'information_retrieval':
                        return content.includes('search') || content.includes('find') || content.includes('research');
                    default:
                        return true;
                }
            });
            
            return relevantMessages.slice(-5); // Return last 5 relevant messages
        }
        
        function updateAgentPerformance(agentId, result) {
            if (!state.analytics.metrics.agentPerformance) {
                state.analytics.metrics.agentPerformance = {};
            }
            
            if (!state.analytics.metrics.agentPerformance[agentId]) {
                state.analytics.metrics.agentPerformance[agentId] = {
                    successRate: 0,
                    avgResponseTime: 0,
                    totalCalls: 0,
                    totalSuccess: 0,
                    totalTime: 0
                };
            }
            
            const perf = state.analytics.metrics.agentPerformance[agentId];
            perf.totalCalls++;
            perf.totalTime += result.processingTime || 0;
            
            if (result.success !== false) {
                perf.totalSuccess++;
            }
            
            perf.successRate = perf.totalSuccess / perf.totalCalls;
            perf.avgResponseTime = perf.totalTime / perf.totalCalls;
        }
        
        function parseExecutionPlan(planContent) {
            // Parse the orchestrator's plan into structured steps
            // This is a simplified version - in production, use more sophisticated parsing
            const steps = [];
            const lines = planContent.split('\n');
            
            let currentStep = null;
            for (const line of lines) {
                if (line.match(/^\d+\./)) {
                    // New step
                    if (currentStep) {
                        steps.push(currentStep);
                    }
                    currentStep = {
                        id: uuidv4(),
                        agent: extractAgentFromLine(line),
                        input: line.replace(/^\d+\.\s*/, ''),
                        dependencies: []
                    };
                } else if (currentStep && line.trim()) {
                    // Continuation of current step
                    currentStep.input += ' ' + line.trim();
                }
            }
            
            if (currentStep) {
                steps.push(currentStep);
            }
            
            return {
                id: uuidv4(),
                steps,
                createdAt: Date.now()
            };
        }
        
        function extractAgentFromLine(line) {
            // Extract agent assignment from line
            const agentMatch = line.match(/@(\w+)/);
            if (agentMatch) {
                const agentName = agentMatch[1];
                return Object.values(state.agents.specialized).find(a => 
                    a.name.toLowerCase().includes(agentName.toLowerCase())
                )?.id || 'research_agent';
            }
            
            // Default agent based on content
            if (line.toLowerCase().includes('code') || line.toLowerCase().includes('function')) {
                return 'code_agent';
            } else if (line.toLowerCase().includes('data') || line.toLowerCase().includes('analyze')) {
                return 'analysis_agent';
            } else if (line.toLowerCase().includes('create') || line.toLowerCase().includes('write')) {
                return 'creative_agent';
            }
            
            return 'research_agent';
        }
        
        function determineWorkflow(agents, metadata) {
            if (agents.length === 1) {
                return 'single';
            } else if (metadata.complexity === 'high' && agents.length > 2) {
                return 'orchestrator';
            } else if (agents.every(agent => 
                ['code_agent', 'analysis_agent'].includes(agent.id)
            )) {
                return 'sequential';
            } else {
                return 'concurrent';
            }
        }
        
        async function updateConversationMemory(userMessage, aiResponse, agents) {
            try {
                // Update episodic memory with emotional context
                const emotionalContext = analyzeEmotionalContext({
                    type: 'exchange',
                    userMessage,
                    aiResponse,
                    agents: agents.map(a => a.id)
                });
                
                state.memory.episodic.data.push({
                    type: 'conversation_exchange',
                    timestamp: Date.now(),
                    userMessage,
                    aiResponse,
                    agents: agents.map(a => a.id),
                    emotionalContext,
                    importanceScore: calculateImportanceScore({ userMessage, aiResponse })
                });
                
                // Compress old memories if needed
                if (state.memory.episodic.data.length > 1000) {
                    await compressEpisodicMemory();
                }
                
            } catch (error) {
                console.error('Error updating conversation memory:', error);
            }
        }
        
        function analyzeEmotionalContext(data) {
            // Simple emotional analysis (in production, use proper sentiment analysis)
            const text = (data.userMessage || '') + ' ' + (data.aiResponse || '');
            const positiveWords = ['good', 'great', 'excellent', 'amazing', 'wonderful', 'helpful'];
            const negativeWords = ['bad', 'terrible', 'awful', 'horrible', 'useless', 'wrong'];
            
            const positiveCount = positiveWords.filter(word => 
                text.toLowerCase().includes(word)
            ).length;
            
            const negativeCount = negativeWords.filter(word => 
                text.toLowerCase().includes(word)
            ).length;
            
            if (positiveCount > negativeCount) {
                return 'positive';
            } else if (negativeCount > positiveCount) {
                return 'negative';
            } else {
                return 'neutral';
            }
        }
        
        function calculateImportanceScore(data) {
            let score = 0;
            
            // Length importance
            const totalLength = (data.userMessage || '').length + (data.aiResponse || '').length;
            score += Math.min(totalLength / 100, 1) * 0.3;
            
            // Agent diversity importance
            if (data.agents && data.agents.length > 1) {
                score += 0.2;
            }
            
            // Code importance
            if ((data.userMessage || '').includes('```') || (data.aiResponse || '').includes('```')) {
                score += 0.3;
            }
            
            // Question importance
            if ((data.userMessage || '').includes('?')) {
                score += 0.2;
            }
            
            return Math.min(score, 1);
        }
        
        function isSignificantMessage(messageData) {
            return calculateImportanceScore(messageData) > 0.5;
        }
        
        async function compressWorkingMemory() {
            // Compress working memory by summarizing old messages
            const oldMessages = state.memory.working.data.slice(0, -10);
            const summary = await summarizeMessages(oldMessages);
            
            state.memory.working.data = [
                { type: 'summary', content: summary, timestamp: Date.now() },
                ...state.memory.working.data.slice(-10)
            ];
        }
        
        async function compressEpisodicMemory() {
            // Compress episodic memory by keeping only important memories
            state.memory.episodic.data = state.memory.episodic.data
                .filter(memory => memory.importanceScore > 0.7)
                .slice(-500); // Keep last 500 important memories
        }
        
        async function summarizeMessages(messages) {
            // Simple summarization (in production, use proper summarization models)
            const totalLength = messages.reduce((sum, msg) => sum + msg.content.length, 0);
            
            if (totalLength < 1000) {
                return messages.map(msg => msg.content).join(' ');
            }
            
            return `Summary of ${messages.length} messages covering ${totalLength} characters of discussion.`;
        }
        
        async function compressMessage(message) {
            // Compress message for storage
            return {
                ...message,
                content: message.content.length > 500 ? 
                    message.content.substring(0, 500) + '...' : message.content
            };
        }
        
        function calculateAgentUtilization() {
            const totalAgentCapacity = Object.keys(state.agents.specialized).length * 100;
            const usedCapacity = Object.values(state.analytics.metrics.agentUsage || {})
                .reduce((sum, usage) => sum + usage, 0);
            
            return Math.round((usedCapacity / totalAgentCapacity) * 100);
        }
        
        function calculateUserSatisfaction() {
            // Calculate based on likes, response times, and successful interactions
            const totalMessages = state.chat.messages.filter(msg => msg.type === 'ai').length;
            const likedMessages = document.querySelectorAll('.message-action.active').length;
            
            if (totalMessages === 0) return 0;
            
            return Math.round((likedMessages / totalMessages) * 100);
        }
        
        function calculateConversationDuration() {
            if (state.chat.messages.length < 2) return 0;
            
            const firstMessage = new Date(state.chat.messages[0].timestamp);
            const lastMessage = new Date(state.chat.messages[state.chat.messages.length - 1].timestamp);
            
            return lastMessage - firstMessage;
        }
        
        function getAgentUsage(agentId) {
            return state.analytics.metrics.agentUsage?.[agentId] || 0;
        }
        
        function updateQuotaAndAnalytics(agents, toolsUsed, processingTime) {
            // Update quota
            state.quota.used += 1;
            state.quota.messagesLeft -= 1;
            state.quota.agentCalls -= agents.length;
            
            // Update tool usage
            toolsUsed.forEach(tool => {
                if (!state.tools.usage[tool]) {
                    state.tools.usage[tool] = 0;
                }
                state.tools.usage[tool]++;
            });
            
            // Update response time analytics
            state.analytics.metrics.responseTimes.push(processingTime);
            
            // Keep only last 100 response times
            if (state.analytics.metrics.responseTimes.length > 100) {
                state.analytics.metrics.responseTimes = state.analytics.metrics.responseTimes.slice(-100);
            }
            
            updateQuotaBar();
        }
        
        function triggerProactiveSuggestions(input) {
            if (!state.proactive.enabled) return;
            
            // Analyze input as user types
            const suggestions = [];
            
            if (input.toLowerCase().includes('help')) {
                suggestions.push({
                    type: 'assistance',
                    content: 'I can help you with various tasks. What specific area do you need help with?',
                    confidence: 0.9
                });
            }
            
            if (input.toLowerCase().includes('code') && input.length > 10) {
                suggestions.push({
                    type: 'coding',
                    content: 'Need help with coding? I can assist with debugging, optimization, and best practices.',
                    confidence: 0.8
                });
            }
            
            state.proactive.suggestions = suggestions;
            updateProactivePanel();
        }
        
        function triggerProactiveActions(userMessage, aiResponse) {
            if (!state.proactive.enabled) return;
            
            // Analyze conversation for proactive actions
            const actions = [];
            
            if (userMessage.toLowerCase().includes('project') && 
                aiResponse.toLowerCase().includes('plan')) {
                actions.push({
                    type: 'project_planning',
                    content: 'Would you like me to create a detailed project timeline with milestones?',
                    timing: 'immediate'
                });
            }
            
            if (userMessage.toLowerCase().includes('learn') && 
                aiResponse.toLowerCase().includes('tutorial')) {
                actions.push({
                    type: 'learning_path',
                    content: 'I can create a personalized learning path based on your goals.',
                    timing: 'delayed'
                });
            }
            
            // Execute or schedule proactive actions
            actions.forEach(action => {
                if (action.timing === 'immediate') {
                    executeProactiveAction(action);
                } else {
                    scheduleProactiveAction(action);
                }
            });
        }
        
        function executeProactiveAction(action) {
            // Execute the proactive action
            console.log('Executing proactive action:', action);
            
            // In production, this would:
            // 1. Create a new message with the suggestion
            // 2. Add it to the proactive suggestions panel
            // 3. Possibly send it directly based on user preferences
        }
        
        function scheduleProactiveAction(action) {
            // Schedule the proactive action for later
            setTimeout(() => {
                executeProactiveAction(action);
            }, 300000); // 5 minutes delay
        }
        
        function analyzeConversationContext(messages) {
            // Analyze conversation context for proactive suggestions
            const context = [];
            
            messages.forEach(message => {
                context.push(...message.content.toLowerCase().split(/\s+/));
            });
            
            return [...new Set(context)];
        }
        
        function loadUserPatterns() {
            // Load user behavior patterns from memory or storage
            // This would be implemented with proper pattern recognition algorithms
            state.proactive.userPatterns = {
                preferredTopics: [],
                activeHours: [],
                responseStyle: 'balanced'
            };
        }
        
        function updateResponsiveLayouts() {
            // Update responsive layouts based on window size
            const width = window.innerWidth;
            
            if (width <= 768) {
                // Mobile layout adjustments
                document.querySelector('.sidebar-right').style.width = '100%';
            } else if (width <= 1024) {
                // Tablet layout adjustments
                document.querySelector('.sidebar-right').style.width = '280px';
            } else {
                // Desktop layout adjustments
                document.querySelector('.sidebar-right').style.width = '350px';
            }
        }
        
        function updateConnectionStatus(status) {
            state.api.status = status;
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        function pauseBackgroundProcesses() {
            // Pause non-essential background processes
            if (state.proactive.engine) {
                clearInterval(state.proactive.engine);
            }
            
            if (state.analytics.collection) {
                clearInterval(state.analytics.collection);
            }
        }
        
        function resumeBackgroundProcesses() {
            // Resume background processes
            if (state.proactive.enabled) {
                initializeProactiveEngine();
            }
            
            initializeAnalyticsCollection();
        }
        
        function triggerPostMessageActions(messageDiv) {
            // Trigger actions after message is displayed
            const messageData = state.chat.messages[state.chat.messages.length - 1];
            
            // Update analytics
            if (messageData.type === 'ai') {
                state.analytics.metrics.messages++;
            }
            
            // Trigger real-time updates if collaboration is enabled
            if (state.collaboration.enabled && state.collaboration.realtimeUpdates) {
                broadcastMessageUpdate(messageData);
            }
        }
        
        function broadcastMessageUpdate(messageData) {
            if (!state.collaboration.websocket || 
                state.collaboration.websocket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            state.collaboration.websocket.send(JSON.stringify({
                type: 'message_update',
                data: messageData,
                sessionId: state.chat.sessionId,
                userId: state.auth.user.uid
            }));
        }
        
        function handleCollaborationMessage(message) {
            // Handle incoming collaboration messages
            switch (message.type) {
                case 'message_update':
                    // Update UI with remote message
                    break;
                case 'user_joined':
                    // Update active users list
                    break;
                case 'user_left':
                    // Update active users list
                    break;
                default:
                    console.log('Unknown collaboration message type:', message.type);
            }
        }
        
        async function initializeUserData(userId) {
            try {
                // Load user-specific data from Firestore
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Load user preferences
                    state.ui.theme = userData.theme || 'light';
                    state.proactive.enabled = userData.proactiveEnabled !== false;
                    
                    // Load user memory
                    if (userData.memory) {
                        state.memory.longTerm.data = userData.memory.longTerm || [];
                        state.memory.episodic.data = userData.memory.episodic || [];
                    }
                    
                    // Load user patterns
                    if (userData.patterns) {
                        state.proactive.userPatterns = userData.patterns;
                    }
                }
                
            } catch (error) {
                console.error('Error initializing user data:', error);
            }
        }
        
        async function saveSessionData() {
            if (!state.auth.user) return;
            
            try {
                await db.collection('users').doc(state.auth.user.uid).update({
                    lastSession: {
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        messagesCount: state.chat.messages.length,
                        sessionId: state.chat.sessionId
                    },
                    memory: {
                        longTerm: state.memory.longTerm.data,
                        episodic: state.memory.episodic.data
                    },
                    patterns: state.proactive.userPatterns,
                    analytics: {
                        totalConversations: state.analytics.metrics.conversations,
                        totalMessages: state.analytics.metrics.messages
                    }
                });
                
            } catch (error) {
                console.error('Error saving session data:', error);
            }
        }
        
        async function loadUserMemory() {
            if (!state.auth.user) return;
            
            try {
                const memoryDoc = await db.collection('users').doc(state.auth.user.uid)
                    .collection('memory').doc('longTerm').get();
                
                if (memoryDoc.exists) {
                    const memoryData = memoryDoc.data();
                    state.memory.longTerm.data = memoryData.data || [];
                    state.memory.episodic.data = memoryData.episodic || [];
                }
                
            } catch (error) {
                console.error('Error loading user memory:', error);
            }
        }
        
        async function restoreConversationContext(context) {
            // Restore conversation context if available
            if (context && context.memoryState) {
                state.memory.working.data = context.memoryState.working || [];
                state.memory.shortTerm.data = context.memoryState.shortTerm || [];
            }
        }
        
        function detectUnusualPatterns() {
            const patterns = [];
            
            // Check for unusual request frequency
            const recentRequests = state.chat.messages.filter(msg => 
                new Date(msg.timestamp) > Date.now() - 60000 // Last minute
            ).length;
            
            if (recentRequests > 50) {
                patterns.push('High request frequency');
            }
            
            // Check for unusual message lengths
            const avgLength = state.chat.messages.reduce((sum, msg) => 
                sum + msg.content.length, 0) / state.chat.messages.length;
            
            if (avgLength > 1000) {
                patterns.push('Unusually long messages');
            }
            
            return patterns;
        }
        
        function viewAgentDetails(agentId) {
            // Show agent details modal
            const agent = state.agents.specialized[agentId] || 
                         (agentId === 'orchestrator' ? state.agents.orchestrator : null);
            
            if (!agent) return;
            
            const details = `
Agent: ${agent.name}
Status: ${agent.status}
Model: ${agent.model}
Specialty: ${agent.specialty}
Capabilities: ${agent.capabilities.join(', ')}
Performance: ${JSON.stringify(getAgentPerformance(agentId), null, 2)}
            `;
            
            alert(details);
        }
        
        function selectAgent(agentId) {
            // Select specific agent for next message
            showToast(`Agent ${agentId} selected for next message`, 'info');
        }
        
        function updateAgentStatusList() {
            const agentStatusList = document.getElementById('agentStatusList');
            if (!agentStatusList) return;
            
            agentStatusList.innerHTML = '';
            
            Object.values(state.agents.specialized).forEach(agent => {
                const perf = getAgentPerformance(agent.id);
                const statusItem = document.createElement('div');
                statusItem.className = 'project-item';
                statusItem.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <div style="flex: 1;">
                        <span>${agent.name}</span>
                        <div style="font-size: 11px; color: var(--text-tertiary);">
                            Success: ${Math.round(perf.successRate * 100)}% | 
                            Avg Time: ${perf.avgResponseTime}ms
                        </div>
                    </div>
                    <span class="agent-status-indicator ${agent.status}"></span>
                `;
                agentStatusList.appendChild(statusItem);
            });
        }
        
        function openAgentSettings() {
            // Open agent-specific settings modal
            showToast('Agent settings coming soon!', 'info');
        }
        
        function toggleTwoFactor() {
            const toggle = document.getElementById('twoFactorToggle');
            state.auth.mfaEnabled = !state.auth.mfaEnabled;
            toggle.classList.toggle('active');
            showToast(`Two-factor authentication ${state.auth.mfaEnabled ? 'enabled' : 'disabled'}`, 'success');
        }
        
        function toggleAgentOrchestration() {
            const toggle = document.getElementById('agentOrchestrationToggle');
            // Toggle would affect how agents are coordinated
            toggle.classList.toggle('active');
            showToast(`Agent orchestration ${toggle.classList.contains('active') ? 'enabled' : 'disabled'}`, 'success');
        }
        
        function toggleProactiveIntelligence() {
            const toggle = document.getElementById('proactiveToggle');
            state.proactive.enabled = !state.proactive.enabled;
            toggle.classList.toggle('active');
            
            if (state.proactive.enabled) {
                initializeProactiveEngine();
                showToast('Proactive intelligence enabled', 'success');
            } else {
                if (state.proactive.engine) {
                    clearInterval(state.proactive.engine);
                }
                showToast('Proactive intelligence disabled', 'info');
            }
        }
        
        function toggleAutonomousWorkflows() {
            const toggle = document.getElementById('autonomousToggle');
            // Toggle would affect agent autonomy
            toggle.classList.toggle('active');
            showToast(`Autonomous workflows ${toggle.classList.contains('active') ? 'enabled' : 'disabled'}`, 'success');
        }
        
        function changeContextWindow(value) {
            // Update context window size
            state.memory.working.capacity = parseInt(value);
            showToast(`Context window updated to ${value} tokens`, 'success');
        }
        
        function exportData() {
            // Export user data
            const userData = {
                conversations: state.chat.messages,
                memory: {
                    working: state.memory.working.data,
                    shortTerm: state.memory.shortTerm.data,
                    longTerm: state.memory.longTerm.data,
                    episodic: state.memory.episodic.data
                },
                preferences: {
                    theme: state.ui.theme,
                    tone: state.preferences.tone,
                    proactiveEnabled: state.proactive.enabled
                },
                analytics: state.analytics.metrics,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aj-studioz-data-export-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }
        
        async function verifyMFA(user) {
            // Implement MFA verification
            const code = prompt('Enter your MFA code:');
            if (code) {
                // Verify MFA code with your auth provider
                // This is a placeholder - implement actual MFA verification
                return true;
            }
            return false;
        }
        
        function updateMessageFeedback(messageId, feedback) {
            // Update message feedback in analytics
            if (!state.analytics.metrics.messageFeedback) {
                state.analytics.metrics.messageFeedback = {};
            }
            
            state.analytics.metrics.messageFeedback[messageId] = feedback;
        }
        
        function startAgentMonitoring() {
            // Start monitoring agent statuses
            setInterval(() => {
                Object.entries(state.agents.specialized).forEach(([id, agent]) => {
                    // Simulate agent status changes
                    if (Math.random() < 0.1) { // 10% chance of status change
                        const newStatus = Math.random() < 0.8 ? 'online' : 'busy';
                        updateAgentStatus(id, newStatus);
                    }
                });
            }, 10000); // Check every 10 seconds
        }
        
        // Initialize NLP library (compromise.js)
        if (typeof nlp !== 'undefined') {
            // NLP is available
            console.log('NLP library loaded successfully');
        } else {
            console.warn('NLP library not available');
        }
        
    </script>
</body>
</html>
